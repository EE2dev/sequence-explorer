!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3"),require("d3-interpolate"),require("d3-array"),require("d3-scale"),require("d3-collection")):"function"==typeof define&&define.amd?define(["exports","d3","d3-interpolate","d3-array","d3-scale","d3-collection"],t):t(e.sequenceExplorer=e.sequenceExplorer||{},e.d3,e.d3,e.d3,e.d3,e.d3)}(this,function(e,t,n,o,s,l){"use strict";function r(){function e(){w.forEach(function(e){e.sourceLinks=[],e.targetLinks=[]}),Y.forEach(function(e){var t=e.source,n=e.target;"number"==typeof t&&(t=e.source=w[e.source]),"number"==typeof n&&(n=e.target=w[e.target]),t.sourceLinks.push(e),n.targetLinks.push(e)})}function t(){w.forEach(function(e){e.value=Math.max(o.sum(e.sourceLinks,c),o.sum(e.targetLinks,c))})}function r(){d=A?d:o.max(w,function(e){return e.value}),f=(x[1]/b.length-v)/d,y&&console.log("ky: "+f),w.forEach(function(e){e.dy=e.value*f,e.dx=m}),Y.forEach(function(e){e.dy=e.value*f})}function a(){y&&console.log(x),g=s.scalePoint().domain(k).range([0,x[0]-m]),p=s.scalePoint().domain(b).range([x[1],x[1]/b.length]),w.forEach(function(e){e.x=g(e.nameX),e.y=p(e.nameY)-e.dy,y&&(console.log("x "+e.nameX+" -> "+e.x),console.log("y "+e.nameY+" -> "+e.y))}),y&&console.log(w)}function i(){function e(e,t){return e.source.y-t.source.y}function t(e,t){return e.target.y-t.target.y}w.forEach(function(n){n.sourceLinks.sort(t),n.targetLinks.sort(e)}),w.forEach(function(e){var t=0,n=0;e.sourceLinks.forEach(function(e){e.sy=t,t+=e.dy}),e.targetLinks.forEach(function(e){e.ty=n,n+=e.dy})})}function c(e){return e.value}var u,f,d,g,p,h={},y=!1,m=15,v=8,x=[700,500],k=[],b=[],A=!1,w=[],Y=[];return h.debugOn=function(e){return arguments.length?(y=e,h):y},h.nodeWidth=function(e){return arguments.length?(m=+e,h):m},h.nodePadding=function(e){return arguments.length?(v=+e,h):v},h.nodes=function(e){return arguments.length?(w=e,h):w},h.links=function(e){return arguments.length?(Y=e,h):Y},h.sequence=function(e){return arguments.length?(k=e,h):k},h.categories=function(e){return arguments.length?(b=e,h):b},h.correspondingCategories=function(e){return arguments.length?(u=function(){return e},h):u()},h.size=function(e){return arguments.length?(x=e,h):x},h.xScale=function(e){return arguments.length?(g=e,h):g},h.yScale=function(e){return arguments.length?(p=e,h):p},h.relayout=function(){return i(),h},h.link=function(){function e(e){t=Math.abs(e.source.x-e.target.x)<e.source.dx?-3:.5;var o=e.source.x+e.source.dx,s=e.target.x,l=n.interpolateNumber(o,s),r=l(t),a=l(1-t),i=e.source.y+e.sy+e.dy/2,c=e.target.y+e.ty+e.dy/2;return"M"+o+","+i+"C"+r+","+i+" "+a+","+c+" "+s+","+c}var t=.5;return e.curvature=function(n){return arguments.length?(t=+n,e):t},e},h.layout=function(){return e(),t(),r(),a(),i(),h},h.getNodeHeight=function(e){return e*f},h.maxValue=function(e){return arguments.length?-1===e?void(A=!1):(d=e,A=!0,h):d},h.addValues=function(){var e=l.map(),t=void 0;k.forEach(function(t){e.set(t,0)}),b.forEach(function(t){e.set(t,0)});var n=void 0;w.forEach(function(o){e.set(o.nameX,e.get(o.nameX)+o.value),e.set(o.nameY,e.get(o.nameY)+o.value),-1!==u().indexOf(o.nameY)&&u().forEach(function(t){n="corr"+o.nameX+t,void 0===e.get(n)&&e.set(n,0),e.set(n,e.get(n)+o.value)}),t=-1,k.forEach(function(e,n){e===o.nameX&&(t=n)}),0===t&&e.set("first"+k[0]+o.nameY,o.value),t!==k.length-1&&e.set("prev"+k[t+1]+o.nameY,o.value)}),w.forEach(function(t){t.valueX=e.get(t.nameX),t.valueY=e.get(t.nameY),t.valueXCorr=e.get("corr"+t.nameX+t.nameY),t.valueYPrev=e.get("prev"+t.nameX+t.nameY),t.valueYFirst=e.get("first"+k[0]+t.nameY)})},h}function a(e){var n=19,o=19,s=e.style("width").indexOf("px");-1!=s&&(n+=+e.style("width").substr(0,s)),-1!=(s=e.style("height").indexOf("px"))&&(o+=+e.style("height").substr(0,s));var l=t.event.pageY-100<0?t.event.pageY+23:t.event.pageY-o,r=t.event.pageX+250<window.innerWidth?t.event.pageX+5:t.event.pageX-n;return e.style("top",l+"px").style("left",r+"px")}function i(e){var t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttributeNS(null,"transform",e);var n=t.transform.baseVal.consolidate().matrix;return[n.e,n.f]}function c(e,n,o){if(isNaN(parseFloat(e)))return"-";var s=t.format(o);if("."===n){if(+e%1!=0)return s(e).split(".").join(",");return s(e).split(",").join(".")}return s(+e%1!=0?e:e)}function u(e){return void 0===e?t.ascending:function(t,n){return e.indexOf(t)-e.indexOf(n)}}function f(e,n,o,s,l,r){var a=n[0]-o.left-o.right,i=n[1]-o.bottom-o.top,c={left:0,bottom:0,right:0,top:20},u={left:20,bottom:0,right:0,top:20},f=e.append("g").attr("class","dummy d1").style("opacity",0).call(t.axisLeft(t.scalePoint().domain(s))),d=e.append("g").attr("class","dummy d2").style("opacity",0).call(t.axisBottom(t.scalePoint().domain(l))),g=t.select("g.dummy.d2 g.tick:last-child text");c.left=f.node().getBBox().width,c.bottom=d.node().getBBox().height;var p=g.node().getBBox().width/2;a=a-c.left-p-5,i=i-c.bottom-u.top,t.selectAll("g.dummy").remove();var h=t.scalePoint().domain(s).range([i,i/s.length]),y=t.axisLeft(h),m=e.append("g").attr("class","axis left").style("opacity",0).call(y);c.left=m.node().getBBox().width,m.attr("transform","translate("+(c.left-1.5)+", "+c.top+")"),t.selectAll("g.axis.left text").attr("dy","");var v=t.scalePoint().domain(l).range([0,a-r]),x=t.axisBottom(v);m=e.append("g").attr("class","axis bottom").style("opacity",0).call(x),c.bottom=m.node().getBBox().height,m.attr("transform","translate("+c.left+", "+(i+u.top)+")");var k={};return k.paddingSingle=c,k.paddingMultiples=u,k.width=a,k.height=i,t.selectAll("text").classed("unselect",!0),k}function d(e,t,n,o,s){var l=t.width,r=t.height,a=t.paddingMultiples,i=o*l/n.cols,c=s*r/n.rows,u=(1/n.cols*l-a.left)/l,f=(1/n.rows*r-a.top)/r;u>=f?u=f:f=u;var d={};return d.sankeyFrame={},d.sankeyFrame.single="translate("+(i+l/2*u)+", "+(c+r/2*f)+") scale(0.3)",d.sankeyFrame.multiples="translate("+i+", "+c+") ",d.sankeySeq={},d.sankeySeq.single="translate("+t.paddingSingle.left+", 20)",d.sankeySeq.multiples="translate("+a.left+", "+a.top+") scale("+u+", "+f+")",d.pTop={},d.pTop.single="translate("+(a.left+l/2)+", "+(a.top-3)+")",d.pTop.multiples="translate("+(a.left+l/2*u)+", "+(a.top-3)+")",d.pLeft={},d.pLeft.single="translate("+(a.left-3)+", "+(a.top+r/2)+")",d.pLeft.multiples="translate("+(a.left-3)+", "+(a.top+r/2*f)+")",d}function g(e,n){var o=void 0!==n?n:t.transition().duration(1e3);return t.selectAll("g.sankeyFrame").each(function(){this===e?(t.select(this).classed("multiples",!1).classed("single",!0),t.select(this).transition(o).attr("transform","translate(0, 0)"),t.select(this).selectAll("g.pTop").transition(o).attr("transform",function(e){return e.single}),t.select(this).selectAll("text.col.multiples").transition(o).style("opacity",0),t.select(this).selectAll("text.col.single").transition(o).style("opacity",1),t.select(this).selectAll("text.nodeLabel").transition(o).style("opacity",1),t.select(this).selectAll("g.pLeft").transition(o).style("opacity",0),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(o).style("stroke-width","1px"),t.select(this).selectAll("g.sankeySeq").transition(o).attr("transform",function(e){return e.single}),t.selectAll(".axis").transition().delay(800).style("opacity",1),t.selectAll(".coverSankeySeq").transition(o).style("opacity",0)):(t.select(this).classed("multiples",!1),t.select(this).transition(o).attr("transform",function(e){return e.single}).style("opacity",0).style("pointer-events","none"),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(o).style("stroke-width","1px"))}),!1}function p(e){var n=t.transition().duration(1e3);return t.selectAll("g.sankeyFrame").classed("multiples",!0).each(function(){this===e?(t.select(this).classed("single",!1),t.select(this).transition(n).attr("transform",function(e){return e.multiples}),t.select(this).selectAll("g.pTop").transition(n).attr("transform",function(e){return e.multiples}),t.select(this).selectAll("text.col.multiples").transition(n).style("opacity",1),t.select(this).selectAll("text.col.single").transition(n).style("opacity",0),t.select(this).selectAll("text.nodeLabel").transition(n).style("opacity",0),t.select(this).selectAll("g.pLeft").transition(n).style("opacity",1),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(n).style("stroke-width","0px"),t.select(this).selectAll("g.sankeySeq").transition(n).attr("transform",function(e){return e.multiples}),t.selectAll(".axis").transition(n).style("opacity",0),t.selectAll(".coverSankeySeq").transition(n).style("opacity",1)):(t.select(this).transition(n).attr("transform",function(e){return e.multiples}).style("opacity",1).style("pointer-events","auto"),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(n).style("stroke-width","0px"))}),!0}function h(e,n,o,s){var l=[],r={};n.forEach(function(e){r[e]={}});for(var a in e)e.hasOwnProperty(a)&&l.push(e[a].yDest);r.rect=function(e,n){var o=0,s=0;return t.select("svg").append("g").attr("class","dummy l1").style("opacity",0).selectAll("text").data(Object.keys(e)).enter().append("text").style("font-size",n+"px").style("font-family","sans-serif").text(function(t){return e[t].value}).each(function(e){var n=t.select(this).node();o=n.getBBox().width>o?n.getBBox().width:o,s=n.getBBox().height>s?n.getBBox().height:s,r[e].textWidth=n.getBBox().width+18}),t.selectAll("g.dummy").remove(),{width:o+10,height:s+10}}(e,16);var i=function(e,t){var n={},o=e[Object.keys(e)[0]];return t.width<o.xLeft?(n.x=o.xLeft,n.labelLeft=!0):(n.x=o.xRight,n.labelLeft=!1),n}(e,r.rect);return r.yPos=function(e,t,n){function o(e){var n=[];return e.forEach(function(o,s){0!==s&&s!==e.length-1&&n.push(o.top+t/2)}),n}var s=function(e){var o=[],s={top:n,bottom:n+t};return o.push(s),e.forEach(function(e){s={top:e-t/2,bottom:e+t/2},o.push(s)}),s={top:0-t,bottom:0},o.push(s),o}(e);s=function(e){return e.forEach(function(t,n){if(0!==n&&n!==e.length-1){var o=e[n-1].top-t.bottom;o<0&&(t.top+=o,t.bottom+=o)}}),e}(s);var l=o(s);return l[l.length-1]<t/2&&(s=function(e){for(var t=e.length;t-- >0;)if(0!==t&&t!==e.length-1){var n=e[t+1].bottom-e[t].top;n>0&&(e[t].top+=n,e[t].bottom+=n)}return e}(s),l=o(s)),l}(l,r.rect.height,o),n.forEach(function(t,n){r[t].xLabel=i.x,r[t].labelLeft=i.labelLeft,r[t].yLabel=r.yPos[n],r[t].yDest=l[n],r[t].yTrans=r[t].yDest-r[t].yLabel,r[t].value=e[t].value}),r.lineX1=0,r.lineY1=0,r}function y(e,n,o,s){var l=e[Object.keys(e)[0]],r=l.xLabel;n.selectAll("g.tick").data(o,function(e){return e}).each(function(n){var o=t.select(this).attr("transform"),a=i(o)[1]+.5,c=e[n].yLabel-a;t.select(this).selectAll("text").transition(s).attr("transform",function(t){return"translate("+(e[t].labelLeft?r:r+e[t].textWidth)+", "+c+")"}).style("font-size","16px").attr("dy","0.35em").on("end",function(){t.select(this).text(function(t){return e[t].value})}),t.select(this).selectAll("line").transition(s).attr("x1",0).attr("y1",function(t){return.5+e[t].yTrans}).attr("x2",function(){return l.labelLeft?-6:6}).attr("transform",function(){return"translate("+r+", "+c+")"})}).exit().transition(s).style("opacity",0),n.selectAll("path.domain").transition(s).style("opacity",0)}function m(e,n,o){e.selectAll("g.tick").data(n,function(e){return e}).each(function(){t.select(this).selectAll("text").text(function(e){return e}).transition(o).attr("transform","translate(0, 0)").style("font-size","10px").attr("dy","0.32em"),t.select(this).selectAll("line").transition(o).attr("x1",0).attr("y1",.5).attr("x2",-6).attr("y2",.5).attr("transform","translate(0,0)")}).exit().transition(o).style("opacity",1),e.selectAll("path.domain").transition(o).style("opacity",1)}function v(e,n,o,s){var l=t.transition().duration(1e3),r=t.select("g.sankeyFrame.single"),a=r.select(".coverSankeySeq").node().getBBox().height;k(r.selectAll("g.links"),l),k(r.selectAll("g.node").filter(function(e){return e.nameX!==n}),l),k(r.selectAll("g.node").filter(function(e){return e.nameX===n}).filter(function(t){return-1===e().indexOf(t.nameY)}),l);var u=r.selectAll("g.node").filter(function(e){return e.nameX===n}).filter(function(t){return-1!==e().indexOf(t.nameY)}),f=0,d=0,g=[];e().forEach(function(e){g.push({name:e,value:0})});var p=0;u.each(function(e){g.forEach(function(t){t.name===e.nameY&&(t.value=e.value,p+=e.value)})}),g.forEach(function(e){d=e.value,e.value=f,f+=d});var m=t.scaleLinear().domain([0,p]).range([0,a-10]),v={},x={};u.transition(l).attr("transform",function(e){var n=i(t.select(this).attr("transform"))[0],o=0;return g.forEach(function(t){t.name===e.nameY&&(o=a-m(t.value+e.value),v[e.nameY]=o,x[e.nameY]=m(e.value))}),"translate ("+n+","+o+")"}),u.selectAll("rect.sankeyNode").transition(l).attr("height",function(e){return m(e.value)});var b=u.selectAll("rect.sankeyNodeInfo");b.classed("zoomed",!0).each(function(e){o.nodeInfoKeys.forEach(function(t){e.nodeInfos[t+"_transY"]=m(e.value-+e.nodeInfos[t]),e.nodeInfos[t+"_transHeight"]=m(+e.nodeInfos[t])})}),b.transition(l).attr("y",function(e){return e.nodeInfos[o.nodeInfoKey+"_transY"]}).attr("height",function(e){return e.nodeInfos[o.nodeInfoKey+"_transHeight"]});var A=i(u.attr("transform"))[0],w=+u.selectAll("rect").filter(function(e,t){return 0===t}).attr("width")+1,Y={},E={},I=e(),L=[];u.each(function(e){Y[e.nameY]=i(t.select(this).attr("transform"))[1],E[e.nameY]=c(""+e.value/e.valueXCorr,s,",.1%")}),I.forEach(function(e){u.filter(function(t){return t.nameY===e}).each(function(){return L.push(e)})});var O=t.selectAll("g.axis.left"),N=r.selectAll(".sankeySeq").node().getBBox().width,S=r.selectAll(".sankeySeq").node().getBBox().height,X={};L.forEach(function(e,t){X[e]={index:t,xLeft:A,xRight:A+w,yDest:v[e]+x[e]/2,value:E[e]+" "+e}}),y(h(X,L,S,N),O,L,l)}function x(e,n,o){var s=t.select("g.sankeyFrame.single"),l=t.transition().duration(1e3),r=t.selectAll("g.axis.left"),a=e(),i=[],c=s.selectAll("g.node").filter(function(){return!t.select(this).classed("hide")});c.each(function(e){-1!==a.indexOf(e.nameY)&&i.push(e.nameY)}),m(r,i,l),c.transition(l).attr("transform",function(e){return"translate ("+e.x+","+e.y+")"}),c.selectAll("rect.sankeyNode").transition(l).attr("height",function(e){return e.dy}),s.selectAll("rect.sankeyNodeInfo").classed("zoomed",!1).transition(l).attr("y",function(e){return e.dy-e.nodeInfos[o.nodeInfoKey+"_dy"]}).attr("height",function(e){return e.nodeInfos[o.nodeInfoKey+"_dy"]}),b(s.selectAll("g.links"),l),b(s.selectAll("g.node"),l)}function k(e,n){e.transition(n).style("opacity",0).on("end",function(){t.select(this).classed("hide",!0)})}function b(e,t){e.classed("hide",!1).transition(t).style("opacity",1)}function A(e,n,o,s){function l(e){var t=void 0;return"%sameTime"===o?t=c(""+e.value/e.valueXCorr,n,",.1%"):"%sameEvent"===o?t=c(""+e.value/e.valueY,n,",.1%"):"%prevEvent"===o?t=c(""+e.value/e.valueYPrev,n,",.1%"):"%firstEvent"===o&&(t=c(""+e.value/e.valueYFirst,n,",.1%")),t}var r=t.transition().duration(1e3),a=t.select("g.sankeyFrame.single"),i=t.select("g.sankeyFrame.single rect.sankeyNode").attr("width")/2;k(a.selectAll("g.links"),r),k(a.selectAll("g.node").filter(function(t){return t.nameY!==e}),r),a.selectAll("g.node").filter(function(t){return t.nameY===e}).append("text").attr("class","percentageLabel").attr("x",function(e){return(s===e.nameX?2:i)+"px"}).attr("y","-5px").text(l).style("text-anchor",function(e){return s===e.nameX?"left":"middle"}).transition(r).style("opacity",1)}function w(){var e=t.select("g.sankeyFrame.single"),n=t.transition().duration(1e3);b(e.selectAll("g.links"),n),b(e.selectAll("g.node"),n),k(t.selectAll("text.percentageLabel"),n)}function Y(e){function n(t){t.each(function(n){console.log(n),console.log("_myData "+e),void 0!==n?y(t,n):void 0!==e?m(e,t):m("<pre>",t)})}function o(e){var n=e.append("div").attr("class","sankeyMenu"),o=n.append("div").attr("class","OptionsMenu");if(o.append("div").attr("class","titleMenu").append("label").text("options"),1!==L.cols||1!==L.rows){o.append("span").attr("class","span1").append("input").attr("class","nodeScaling").attr("type","checkbox").on("change",s).node().checked=F,o.select("span.span1").append("label").text("global scale"),o.append("br")}if(o.append("span").attr("class","span2").append("input").attr("class","labelOnOff").attr("type","checkbox").on("change",l).node().checked=P,n.select("span.span2").append("label").text("node labels"),void 0!==Y){j&&(console.log("nodeInfoKeys: "),console.log(E));var r=t.select("div.sankeyMenu").append("div").attr("class","NodeInfoMenu");r.append("div").attr("class","titleMenu").append("label").text("node info"),r=r.append("form").selectAll("span").data(E).enter().append("span"),r.append("input").attr("type","radio").attr("name","menu").attr("value",function(e){return e}).attr("checked",function(e,t){if(0===t)return"checked"}).on("change",function(){q=this.value,z.nodeInfoKey=q,console.log("nodeInfokey: "+q),h()}),r.append("label").text(function(e){return e}),r.append("br")}}function s(){var e,n,o,s=t.transition().duration(1e3);F=t.select(".nodeScaling").node().checked,L.forEach(function(l,r){l.forEach(function(l,a){e=l.sankey,o=l.graph,F?e.maxValue(L.maxValue):e.maxValue(-1),e.layout(),n="g.sankeySeq.s"+r+"-"+a,t.select(n).selectAll(".link").data(o.links,function(e){return e.id}).transition(s).attr("d",e.link()).style("stroke-width",function(e){return Math.max(1,e.dy)+"px"}),t.select(n).selectAll(".node").data(o.nodes).transition(s).attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),t.select(n).selectAll("rect.sankeyNode").transition(s).attr("height",function(e){return e.dy}),t.select(n).selectAll("text.nodeLabel").transition(s).attr("y",function(e){if(j){var n=i(t.select(this.parentNode).attr("transform"))[1];console.log("transform: "+t.select(this.parentNode).attr("transform")),console.log(n)}var o=parseInt(t.select(this).style("font-size"));return e.dy<o?e.dy-o/2-2:Math.min(e.dy/2,e.dy-o/2-2)}),t.select(n).selectAll("rect.sankeyNodeInfo").filter(function(n){return E.forEach(function(o){o!==_?n.nodeInfos[o+"_dy"]=e.getNodeHeight(+n.nodeInfos[o]):q===_&&t.selectAll("rect.sankeyNodeInfo").attr("y",function(e){return e.dy})}),void 0!==n.nodeInfos}).attr("height",function(){return t.select(this).attr("height")}).transition(s).attr("y",function(e){return q===_?e.dy:(j&&(console.log("value: "+ +e.nodeInfos[q]),console.log("newHeight: "+e.nodeInfos[q+"_dy"])),e.dy-e.nodeInfos[q+"_dy"])}).attr("height",function(e){return q===_?0:e.nodeInfos[q+"_dy"]})})})}function l(){t.selectAll("text.nodeLabel").style("display",function(){return t.select(".labelOnOff").node().checked?"block":"none"})}function h(){var e=t.transition().duration(1e3),n=t.select("rect.sankeyNodeInfo").style("fill"),o=t.color(n).rgb();o.opacity=.1,t.select("div.NodeInfoMenu").transition(e).style("border-color",function(){return q===_?"rgba(0,0,0,0.1)":n}).style("background-color",function(){return q===_?"rgba(0,0,0,0.1)":o.toString()}),t.selectAll("rect.sankeyNodeInfo").style("display","inline").transition(e).attr("y",function(e){return t.select(this).classed("zoomed")?e.nodeInfos[q+"_transY"]:e.dy-e.nodeInfos[q+"_dy"]}).attr("height",function(e){return t.select(this).classed("zoomed")?e.nodeInfos[q+"_transHeight"]:e.nodeInfos[q+"_dy"]}).transition().delay(10).duration(10).style("display",function(){return q===_?"none":"inline"})}function y(e){var s,i,u,h,y,m,k,b,Y,X;e.each(function(){o(e),X=t.select(this).append("div").attr("class","sankeyChart").append("svg").attr("width",D[0]).attr("height",D[1]).append("g").attr("transform","translate("+J.left+","+J.top+")"),b=f(X,D,J,S,N,R),1===L.cols&&1===L.rows&&(t.selectAll(".axis").style("opacity",1),t.selectAll(".sankeyNode,.sankeyNodeInfo").style("stroke-width","1px"),W=C),i=b.width,u=b.height,j&&(console.log("allGraphs:"),console.log(L)),L.forEach(function(e,o){e.forEach(function(e,f){function B(e){var n=W===V||W===K,o=t.select("g.sankeyFrame.single").selectAll("g.node").filter(function(t){return t.nameX===e}),s=0===o.size(),l=o.filter(function(e){return-1!==G().indexOf(e.nameY)}).size(),r=0===l;return n||s||r}function P(e){var t=e(),n=t.sort(function(e,t){return S.indexOf(e)-S.indexOf(t)});e=function(){return n}}function D(e){var n=W===V||W===K,o=t.select("g.sankeyFrame.single").selectAll("g.node").filter(function(t){return t.nameY===e}).size(),s=0===o,l="%sameTime"===M[0]&&-1===G().indexOf(e);return n||s||l}k=e.graph,j&&(console.log("col: "+e.dimCol),console.log("row: "+e.dimRow)),s=r().size([i,u]).sequence(N).categories(S).nodeWidth(R).nodePadding(H).nodes(k.nodes).links(k.links).correspondingCategories(n.correspondingEvents()).debugOn(j),F&&s.maxValue(L.maxValue),s.layout().addValues(),e.sankey=s,Y=d(X,b,L,o,f),t.select("div.sankeyChart > svg").on("click",function(){if(W===K){t.select(".nodeScaling").size>0&&(t.select(".nodeScaling").node().disabled=!1),t.select(".labelOnOff").node().disabled=!1;var e=t.select("g.zoomed").classed("zoomed",!1).datum();x(G,e,z),W=C}else W===V&&(t.select(".nodeScaling").size>0&&(t.select(".nodeScaling").node().disabled=!1),t.select(".labelOnOff").node().disabled=!1,t.select("g.zoomed").classed("zoomed",!1),w(),W=C)}),y=X.append("g").datum(Y.sankeyFrame).attr("class",function(){var e="sankeyFrame f"+o+"-"+f;return e+=1===L.cols&&1===L.rows?" single":" multiples"}).attr("transform",Y.sankeyFrame.multiples).on("click",function(){1===L.cols&&1===L.rows||(W===T?(g(this),W=C):W===C&&(p(this),W=T))}),h=y.append("g").datum(Y.sankeySeq).attr("class","sankeySeq s"+o+"-"+f).attr("transform",Y.sankeySeq.multiples);var J=y.append("g").datum(Y.pTop).attr("class","sankeyPad multiples pTop").attr("transform",Y.pTop.multiples);J.append("text").attr("class","multiples col c"+o).text(function(){return 1===L.cols&&L.rows>1?e.dimRow:e.dimCol}),J.append("text").attr("class","single col c"+o).style("opacity",0).text(function(){return 1===L.cols&&L.rows>1?e.dimRow:e.dimRow+"    "+e.dimCol}),y.append("g").datum(Y.pLeft).attr("class","sankeyPad multiples pLeft").attr("transform",Y.pLeft.multiples).append("text").attr("class","multiples row r"+f).attr("transform","rotate(-90)").text(function(){var t="";return L.cols>1&&L.rows>1&&(t=e.dimRow),t}),h.append("rect").attr("class","coverSankeySeq").attr("height",u).attr("width",i+2).style("stroke","black").style("stroke-width",1).style("fill-opacity",0),O=t.select("body").append("div").attr("class","tooltip"),h.append("g").attr("class","links").selectAll(".link").data(k.links).enter().append("path").attr("class",function(e){return"link lsx"+e.source.nameX.replace(/ /g,"_")+" lsy"+e.source.nameY.replace(/ /g,"_")+" ltx"+e.target.nameX.replace(/ /g,"_")+" lty"+e.target.nameY.replace(/ /g,"_")}).attr("d",s.link()).style("stroke-width",function(e){return Math.max(1,e.dy)+"px"}).sort(function(e,t){return t.dy-e.dy}).on("mouseover",function(e){var t=Z+": "+e.source.nameX+" ⇾ "+e.target.nameX;t+="<br>"+Q+": "+e.source.nameY+" ⇾ "+e.target.nameY,t+="<br>"+I+": "+c(e.value,U,",.0f"),O.html(t),O.style("visibility","visible")}).on("mousemove",function(){var e=19,n=19,o=O.style("width").indexOf("px");-1!=o&&(e+=+O.style("width").substr(0,o)),-1!=(o=O.style("height").indexOf("px"))&&(n+=+O.style("height").substr(0,o));var s=t.event.pageY-100<0?t.event.pageY+23:t.event.pageY-n,l=t.event.pageX+250<window.innerWidth?t.event.pageX+5:t.event.pageX-e;return O.style("top",s+"px").style("left",l+"px")}).on("mouseout",function(){return O.style("visibility","hidden")}),m=h.append("g").attr("class","nodes").selectAll(".node").data(k.nodes).enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),m.append("rect").attr("class",function(e){var t="sankeyNode nx"+e.nameX.replace(/ /g,"_")+" ny"+e.nameY.replace(/ /g,"_");return S.forEach(function(n,o){n===e.nameY&&(t+=" color"+o%5)}),t}).attr("height",function(e){return e.dy}).attr("width",s.nodeWidth()).on("mouseover",function(e){var t=Z+": "+e.nameX;t+="<br>"+Q+": "+e.nameY,t+="<br>"+I+": "+c(e.value,U,",.0f"),M.forEach(function(n){"%sameTime"===n?G().length===S.length?t+="<br>% of '"+e.nameX+"': "+c(""+e.value/e.valueX,U,",.1%"):t+="<br>% of '"+e.nameX+"'(CE): "+c(""+e.value/e.valueXCorr,U,",.1%"):"%sameEvent"===n?t+="<br>% of '"+e.nameY+"': "+c(""+e.value/e.valueY,U,",.1%"):"%prevEvent"===n?t+="<br>% of previous '"+e.nameY+"': "+c(""+e.value/e.valueYPrev,U,",.1%"):"%firstEvent"===n&&(t+="<br>% of first '"+e.nameY+"': "+c(""+e.value/e.valueYFirst,U,",.1%"))}),O.html(t),O.style("visibility","visible")}).on("mousemove",function(){a(O)}).on("mouseout",function(){return O.style("visibility","hidden")}),m.append("text").attr("class","nodeLabel").style("display",function(){return t.select(".labelOnOff").node().checked?"block":"none"}).attr("x",3+s.nodeWidth()).attr("y",function(e){return e.dy/2}).attr("dy",".35em").attr("text-anchor","start").attr("transform",null).style("opacity",0).text(function(e){return e.nameY}).each(function(){j&&(console.log(t.select(this.parentNode).node()),console.log("transform: "+t.select(this.parentNode).attr("transform")));var e=parseInt(t.select(this).style("font-size"));t.select(this).attr("y",function(t){return t.dy<e?t.dy-e/2-2:Math.min(t.dy/2,t.dy-e/2-2)})}).filter(function(e){return e.x>.9*i}).attr("x",-3).attr("text-anchor","end"),m.filter(function(e){return void 0!==e.nodeInfos}).append("rect").attr("class","sankeyNodeInfo").attr("y",function(e){return e.dy}).attr("height",function(e){return E.forEach(function(t){e.nodeInfos[t+"_dy"]=s.getNodeHeight(+e.nodeInfos[t])}),0}).attr("width",s.nodeWidth()).style("display",function(){return q===_?"none":"inline"}).on("mouseover",function(e){var t=Z+": "+e.nameX;t+="<br>"+Q+": "+e.nameY,t+="<br>"+I+" ("+q+"): "+c(e.nodeInfos[q],U,",.0f"),t+="<br>% of node: "+c(""+e.nodeInfos[q]/e.value,U,",.1%"),O.html(t),O.style("visibility","visible")}).on("mousemove",function(){a(O)}).on("mouseout",function(){return O.style("visibility","hidden")}),"single"===e.transform&&g(y.node(),t.transition().duration(0)),t.selectAll("g.axis.bottom > g.tick").on("click",function(e){if(W===C){if(B(e))return;t.select(".nodeScaling").size>0&&(t.select(".nodeScaling").node().disabled=!0),t.select(".labelOnOff").node().checked=!1,l(),t.select(".labelOnOff").node().disabled=!0,t.select(this).classed("zoomed",!0),P(G),v(G,e,z,U),t.event.stopPropagation(),W=K}}),t.selectAll("g.axis.bottom > g.tick").on("mouseover",function(e){if(B(e))return void t.select(this).style("cursor","default");t.select(this).style("cursor","pointer");var n=t.select(this).selectAll("text").node().getBBox(),o=n.width/2+2,s=n.height,l="M0.5 0 L"+-(.5+o+3)+" 8 L"+-(.5+o)+" 8 L"+-(.5+o)+" "+(s+11);l+=" L"+(.5+o)+" "+(s+11)+" L"+(.5+o)+" 8 L"+(.5+o+3)+" 8 Z",t.select(this).selectAll("path").data([e],function(e){return e}).enter().append("path").attr("d",l)}).on("mouseleave",function(){t.select(this).selectAll("path").remove(),t.select(this).style("cursor","default")}),t.selectAll("g.axis.left > g.tick").on("click",function(e){if(W===C){if(D(e))return;t.select(this).classed("zoomed",!0),t.select(".nodeScaling").size>0&&(t.select(".nodeScaling").node().disabled=!0),t.select(".labelOnOff").node().checked=!1,l(),t.select(".labelOnOff").node().disabled=!0,A(e,U,M[0],N[0]),t.event.stopPropagation(),W=V}}),t.selectAll("g.axis.left > g.tick").on("mouseover",function(e){if(D(e))return void t.select(this).style("cursor","default");t.select(this).style("cursor","pointer");var n=t.select(this).selectAll("text").node().getBBox(),o=n.width,s=n.y+n.height/2,l=n.height/2+2,r="M0 "+s+" L-10 "+(s+l+3)+" L-10 "+(s+l)+" L"+-(o+12)+" "+(s+l);r+=" L"+-(o+12)+" "+(s-l)+" L-10 "+(s-l)+" L-10 "+(s-l-3)+" Z",t.select(this).selectAll("path").data([e],function(e){return e}).enter().append("path").attr("d",r)}).on("mouseleave",function(){t.select(this).selectAll("path").remove(),t.select(this).style("cursor","default")})})})})}function m(e,n){if("<pre>"!==e)t.csv(e,function(o,s){var l=e.slice(0,e.lastIndexOf("."))+"_nodes"+e.slice(e.lastIndexOf("."));t.csv(l,function(e,t){j&&(console.log("start"),console.log(e),console.log(t),console.log("end")),Y=t,b=s,j&&(console.log("file: "),console.log(b),console.log("nodeFileName: "),console.log(l),console.log("nodeFile: "),console.log(Y)),L=k(b),y(n)})});else{if(b=t.csvParse(t.select("pre#data").text()),Y=t.csvParse(t.select("pre#dataNodes").text()),0===Y.length){Y=void 0}j&&(console.log("file: "),console.log(b),console.log("nodeFile: "),console.log(Y)),L=k(b),y(n)}}function k(e){var n,o,s,l,r,a,i,c,f={},d=[],g=e.columns,p=[],h=t.map(),y=0,m=t.set(),v=t.set();console.log(e.columns),void 0===I&&(I=e.columns[0]),5===e.columns.length?(p=t.nest().key(function(){return""}).key(function(){return""}).entries(e),void 0!==Y&&(Y.forEach(function(e){s=e.sourceX+","+e.sourceY,h.set(s,e),j&&console.log(e)}),E=Y.columns,E.splice(0,2,_))):6===e.columns.length?(p=t.nest().key(function(){return""}).key(function(e){return e[g[5]]}).sortKeys(u(B)).entries(e),void 0!==Y&&(Y.forEach(function(t){s=t[e.columns[5]]+","+t.sourceX+","+t.sourceY,h.set(s,t),j&&console.log(t)}),E=Y.columns,E.splice(0,3,_))):7===e.columns.length&&(p=t.nest().key(function(e){return e[g[6]]}).sortKeys(u(X)).key(function(e){return e[g[5]]}).sortKeys(u(B)).entries(e),j&&console.log("----------- nodeInfos ------------"),void 0!==Y&&(Y.forEach(function(t){s=t[e.columns[6]]+","+t[e.columns[5]]+","+t.sourceX+","+t.sourceY,h.set(s,t),j&&console.log(t)}),E=Y.columns,E.splice(0,4,_))),d.rows=t.nest().key(function(e){return e[g[5]]}).entries(e).length,d.cols=t.nest().key(function(e){return e[g[6]]}).entries(e).length,j&&(console.log("----------- datagroups ------------"),console.log(p),console.log("----------nodeMap----------"),console.log(h)),p.forEach(function(e,s){d[s]=[],e.values.forEach(function(u){l=u.values,f={nodes:[],links:[]},j&&console.log("graph0: "),l.forEach(function(e,t){j&&(console.log("i: "+t),console.log(e)),n=e[g[1]]+"_"+e[g[2]],o=e[g[3]]+"_"+e[g[4]],f.nodes.push({name:n}),f.nodes.push({name:o}),f.links.push({source:n,target:o,id:n+"->"+o,value:+e[g[0]]}),m.add(e[g[1]]),m.add(e[g[3]]),v.add(e[g[2]]),v.add(e[g[4]])}),j&&(console.log("graph1: "),console.log(JSON.stringify(f))),f.nodes=t.nest().key(function(e){return e.name}).map(f.nodes).keys(),j&&(console.log("graph2: "),console.log(JSON.stringify(f))),f.links.forEach(function(e,t){f.links[t].source=f.nodes.indexOf(f.links[t].source),f.links[t].target=f.nodes.indexOf(f.links[t].target)}),f.nodes.forEach(function(t,n){var o=t.split("_")[0],s=t.split("_")[1];f.nodes[n]={name:t,nameX:o,nameY:s};var l,r=""===e.key?"":e.key+",",a=""===u.key?"":u.key+",";void 0!==(l=h.get(r+a+o+","+s))&&(Object.keys(l).forEach(function(e){l[e+"_dy"]=0}),l[_]=0,f.nodes[n].nodeInfos=l)}),j&&(console.log("graph 3"),console.log(JSON.stringify(f)),console.log(f)),j&&(console.log("categoriesSorted: "),console.log(S)),r={},r.graph=f,r.dimRow=u.key,r.dimCol=e.key,a=t.nest().key(function(e){return e.source}).rollup(function(e){return t.sum(e,function(e){return+e.value})}).entries(f.links),i=t.nest().key(function(e){return e.target}).rollup(function(e){return t.sum(e,function(e){return+e.value})}).entries(f.links),a=a.concat(i),c=t.max(a,function(e){return e.value}),y=c>y?c:y,1===d.cols&&1===d.rows?r.transform="single":r.transform="multiples",d[s].push(r)})}),z.nodeInfoKeys=E,z.nodeInfoNone=_,z.nodeInfoKey=q;var x=m.values().sort(t.ascending),k=v.values().sort(t.ascending);return console.log(" data sequence: "+x),N?console.log("input sequence: "+N):N=x,console.log(" data categories: "+k),S?console.log("input categories: "+S):S=k,j&&console.log("maxValue: "+y),d.maxValue=y,d}var b,Y,E,I,L,O,N,S,X,B,_="(none)",q=_,z={},F=!0,P=!0,M=["%sameTime"],C=1,T=2,K=3,V=4,W=T,j=!1,R=15,H=8,D=[700,500],J={left:5,top:5,right:5,bottom:5},G=function(){return S},Z="sequence",Q="category",U=",";return n.debugOn=function(e){return arguments.length?(j=e,n):j},n.size=function(e){return arguments.length?(D=e,n):D},n.margin=function(e){return arguments.length?(J.left=e,J.top=e,J.right=e,J.bottom=e,n):J},n.nodeWidth=function(e){
return arguments.length?(R=+e,n):R},n.nodePadding=function(e){return arguments.length?(H=+e,n):H},n.sequenceOrder=function(e){return arguments.length?(N=e,n):N},n.eventOrder=function(e){return arguments.length?(S=e,n):S},n.sequenceName=function(e){return arguments.length?(Z=e,n):Z},n.eventName=function(e){return arguments.length?(Q=e,n):Q},n.valueName=function(e){return arguments.length?(I=e,n):I},n.thousandsSeparator=function(e){return arguments.length?(U=e,n):U},n.scaleGlobal=function(e){return arguments.length?(F=e,n):F},n.showNodeLabels=function(e){return arguments.length?(P=e,n):P},n.percentages=function(e){return arguments.length?(M=e,n):M},n.rowOrder=function(e){return arguments.length?(B=e,n):B},n.colOrder=function(e){return arguments.length?(X=e,n):X},n.correspondingEvents=function(e){return arguments.length?(G=function(){return e},n):G()},n}e.chart=Y,Object.defineProperty(e,"__esModule",{value:!0})});