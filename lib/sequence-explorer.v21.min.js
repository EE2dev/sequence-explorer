!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3"),require("d3-interpolate"),require("d3-array"),require("d3-scale"),require("d3-collection")):"function"==typeof define&&define.amd?define(["exports","d3","d3-interpolate","d3-array","d3-scale","d3-collection"],t):t(e.sequenceExplorer=e.sequenceExplorer||{},e.d3,e.d3,e.d3,e.d3,e.d3)}(this,function(e,t,n,o,r,a){"use strict";function s(){function e(){w.forEach(function(e){e.sourceLinks=[],e.targetLinks=[]}),L.forEach(function(e){var t=e.source,n=e.target;"number"==typeof t&&(t=e.source=w[e.source]),"number"==typeof n&&(n=e.target=w[e.target]),t.sourceLinks.push(e),n.targetLinks.push(e)})}function t(){w.forEach(function(e){e.value=Math.max(o.sum(e.sourceLinks,c),o.sum(e.targetLinks,c))})}function s(){d=A?d:o.max(w,function(e){return e.value}),f=(k[1]/b.length-m)/d,y&&console.log("ky: "+f),w.forEach(function(e){e.dy=e.value*f,e.dx=v}),L.forEach(function(e){e.dy=e.value*f})}function l(){y&&console.log(k),h=r.scalePoint().domain(x).range([0,k[0]-v]),g=r.scalePoint().domain(b).range([k[1],k[1]/b.length]),w.forEach(function(e){e.x=h(e.nameX),e.y=g(e.nameY)-e.dy,y&&(console.log("x "+e.nameX+" -> "+e.x),console.log("y "+e.nameY+" -> "+e.y))}),y&&console.log(w)}function i(){function e(e,t){return e.source.name===e.target.name?-1:t.source.name===t.target.name?1:e.source.y-t.source.y}function t(e,t){return e.source.name===e.target.name?-1:t.source.name===t.target.name?1:e.target.y-t.target.y}w.forEach(function(n){n.sourceLinks.sort(t),n.targetLinks.sort(e)});var n=[],o=[];w.forEach(function(e,t){n[t]=0,o[t]=0,e.sourceLinks.forEach(function(e){n[t]+=e.dy}),e.targetLinks.forEach(function(e){o[t]+=e.dy})}),w.forEach(function(e,t){var r=e.dy-n[t],a=e.dy-o[t];e.sourceLinks.forEach(function(e){e.sy=r,r+=e.dy}),e.targetLinks.forEach(function(e){e.ty=a,a+=e.dy})})}function c(e){return e.value}var u,f,d,h,g,p={},y=!1,v=15,m=8,k=[700,500],x=[],b=[],A=!1,w=[],L=[];return p.debugOn=function(e){return arguments.length?(y=e,p):y},p.nodeWidth=function(e){return arguments.length?(v=+e,p):v},p.nodePadding=function(e){return arguments.length?(m=+e,p):m},p.nodes=function(e){return arguments.length?(w=e,p):w},p.links=function(e){return arguments.length?(L=e,p):L},p.sequence=function(e){return arguments.length?(x=e,p):x},p.categories=function(e){return arguments.length?(b=e,p):b},p.correspondingCategories=function(e){return arguments.length?(u=function(){return e},p):u()},p.size=function(e){return arguments.length?(k=e,p):k},p.xScale=function(e){return arguments.length?(h=e,p):h},p.yScale=function(e){return arguments.length?(g=e,p):g},p.relayout=function(){return i(),p},p.link=function(){function e(e){t=Math.abs(e.source.x-e.target.x)<e.source.dx?-3:.5;var o=e.source.x+e.source.dx,r=e.target.x,a=n.interpolateNumber(o,r),s=a(t),l=a(1-t),i=e.source.y+e.sy+e.dy/2,c=e.target.y+e.ty+e.dy/2;return"M"+o+","+i+"C"+s+","+i+" "+l+","+c+" "+r+","+c}var t=.5;return e.curvature=function(n){return arguments.length?(t=+n,e):t},e},p.layout=function(){return e(),t(),s(),l(),i(),p},p.getNodeHeight=function(e){return e*f},p.maxValue=function(e){return arguments.length?-1===e?void(A=!1):(d=e,A=!0,p):d},p.addValues=function(){var e=a.map(),t=void 0;x.forEach(function(t){e.set(t,0)}),b.forEach(function(t){e.set(t,0)});var n=void 0;w.forEach(function(o){e.set(o.nameX,e.get(o.nameX)+o.value),e.set(o.nameY,e.get(o.nameY)+o.value),-1!==u().indexOf(o.nameY)&&u().forEach(function(t){n="corr"+o.nameX+t,void 0===e.get(n)&&e.set(n,0),e.set(n,e.get(n)+o.value)}),t=-1,x.forEach(function(e,n){e===o.nameX&&(t=n)}),0===t&&e.set("first"+x[0]+o.nameY,o.value),t!==x.length-1&&e.set("prev"+x[t+1]+o.nameY,o.value)}),w.forEach(function(t){t.valueX=e.get(t.nameX),t.valueY=e.get(t.nameY),t.valueXCorr=e.get("corr"+t.nameX+t.nameY),t.valueYPrev=e.get("prev"+t.nameX+t.nameY),t.valueYFirst=e.get("first"+x[0]+t.nameY)})},p}function l(e){var n=19,o=19,r=e.style("width").indexOf("px");-1!=r&&(n+=+e.style("width").substr(0,r)),-1!=(r=e.style("height").indexOf("px"))&&(o+=+e.style("height").substr(0,r));var a=t.event.pageY-100<0?t.event.pageY+23:t.event.pageY-o,s=t.event.pageX+250<window.innerWidth?t.event.pageX+5:t.event.pageX-n;return e.style("top",a+"px").style("left",s+"px")}function i(e){var t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttributeNS(null,"transform",e);var n=t.transform.baseVal.consolidate().matrix;return[n.e,n.f]}function c(e,n,o){if(isNaN(parseFloat(e)))return"-";var r=t.format(o);if("."===n){if(+e%1!=0)return r(e).split(".").join(",");return r(e).split(",").join(".")}return r(+e%1!=0?e:e)}function u(e){return void 0===e?t.ascending:function(t,n){return e.indexOf(t)-e.indexOf(n)}}function f(e){var t=e.select("g.sankeyFrame.single").attr("class").split(" ")[1],n=t.substring(1,t.length).split("-");return{col:+n[0],row:+n[1]}}function d(e,n,o,r,a,s){var l=n[0]-o.left-o.right,i=n[1]-o.bottom-o.top,c={left:0,bottom:0,right:0,top:20},u={left:20,bottom:0,right:0,top:20},f=e.append("g").attr("class","dummy d1").style("opacity",0).call(t.axisLeft(t.scalePoint().domain(r))),d=e.append("g").attr("class","dummy d2").style("opacity",0).call(t.axisBottom(t.scalePoint().domain(a))),h=e.select("g.dummy.d2 g.tick:last-child text");c.left=f.node().getBBox().width,c.bottom=d.node().getBBox().height;var g=h.node().getBBox().width/2;l=l-c.left-g-7,i=i-c.bottom-u.top-2,e.selectAll("g.dummy").remove();var p=t.scalePoint().domain(r).range([i,i/r.length]),y=t.axisLeft(p),v=e.append("g").attr("class","axis left").style("opacity",0).call(y);c.left=v.node().getBBox().width,v.attr("transform","translate("+(c.left-1.5)+", "+c.top+")"),e.selectAll("g.axis.left text").attr("dy","");var m=t.scalePoint().domain(a).range([0,l-s]),k=t.axisBottom(m);v=e.append("g").attr("class","axis bottom").style("opacity",0).call(k),c.bottom=v.node().getBBox().height,v.attr("transform","translate("+c.left+", "+(i+u.top)+")");var x={};x.paddingSingle=c,x.paddingMultiples=u,x.width=l,x.height=i;var b={};return b.x=o.left+c.left,b.y=o.top+c.top,x.particleStart=b,e.selectAll("text").classed("unselect",!0),x}function h(e,t,n,o,r){var a=t.width,s=t.height,l=t.paddingMultiples,i=o*a/n.cols,c=r*s/n.rows,u=(1/n.cols*a-l.left)/a,f=(1/n.rows*s-l.top)/s;u>=f?u=f:f=u;var d={};return d.sankeyFrame={},d.sankeyFrame.single="translate("+(i+a/2*u)+", "+(c+s/2*f)+") scale(0.3)",d.sankeyFrame.multiples="translate("+i+", "+c+") ",d.sankeySeq={},d.sankeySeq.single="translate("+t.paddingSingle.left+", 20)",d.sankeySeq.multiples="translate("+l.left+", "+l.top+") scale("+u+", "+f+")",d.pTop={},d.pTop.single="translate("+(l.left+a/2)+", "+(l.top-3)+")",d.pTop.multiples="translate("+(l.left+a/2*u)+", "+(l.top-3)+")",d.pLeft={},d.pLeft.single="translate("+(l.left-3)+", "+(l.top+s/2)+")",d.pLeft.multiples="translate("+(l.left-3)+", "+(l.top+s/2*f)+")",d}function g(e,n,o){var r=void 0!==o?o:t.transition().duration(1e3);return e.selectAll("g.sankeyFrame").each(function(){this===n?(t.select(this).classed("multiples",!1).classed("single",!0),t.select(this).transition(r).attr("transform","translate(0, 0)"),t.select(this).selectAll("g.pTop").transition(r).attr("transform",function(e){return e.single}),t.select(this).selectAll("text.col.multiples").transition(r).style("opacity",0),t.select(this).selectAll("text.col.single").transition(r).style("opacity",1),t.select(this).selectAll("text.nodeLabel").transition(r).style("opacity",1),t.select(this).selectAll("g.pLeft").transition(r).style("opacity",0),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(r).style("stroke-width","1px"),t.select(this).selectAll("g.sankeySeq").transition(r).attr("transform",function(e){return e.single}),e.selectAll(".axis").transition().delay(800).style("opacity",1),e.selectAll(".coverSankeySeq").transition(r).style("opacity",0)):(t.select(this).classed("multiples",!1),t.select(this).transition(r).attr("transform",function(e){return e.single}).style("opacity",0).style("pointer-events","none"),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(r).style("stroke-width","1px"))}),!1}function p(e,n){var o=t.transition().duration(1e3);return e.selectAll("g.sankeyFrame").classed("multiples",!0).each(function(){this===n?(t.select(this).classed("single",!1),t.select(this).transition(o).attr("transform",function(e){return e.multiples}),t.select(this).selectAll("g.pTop").transition(o).attr("transform",function(e){return e.multiples}),t.select(this).selectAll("text.col.multiples").transition(o).style("opacity",1),t.select(this).selectAll("text.col.single").transition(o).style("opacity",0),t.select(this).selectAll("text.nodeLabel").transition(o).style("opacity",0),t.select(this).selectAll("g.pLeft").transition(o).style("opacity",1),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(o).style("stroke-width","0px"),t.select(this).selectAll("g.sankeySeq").transition(o).attr("transform",function(e){return e.multiples}),e.selectAll(".axis").transition(o).style("opacity",0),e.selectAll(".coverSankeySeq").transition(o).style("opacity",1)):(t.select(this).transition(o).attr("transform",function(e){return e.multiples}).style("opacity",1).style("pointer-events","auto"),t.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(o).style("stroke-width","0px"))}),!0}function y(e,n,o,r,a){var s=[],l={};o.forEach(function(e){l[e]={}});for(var i in n)n.hasOwnProperty(i)&&s.push(n[i].yDest);l.rect=function(n,o){var r=0,a=0;return e.select("svg").append("g").attr("class","dummy l1").style("opacity",0).selectAll("text").data(Object.keys(n)).enter().append("text").style("font-size",o+"px").style("font-family","sans-serif").text(function(e){return n[e].value}).each(function(e){var n=t.select(this).node();r=n.getBBox().width>r?n.getBBox().width:r,a=n.getBBox().height>a?n.getBBox().height:a,l[e].textWidth=n.getBBox().width+18}),e.selectAll("g.dummy").remove(),{width:r+10,height:a+10}}(n,16);var c=function(e,t){var n={},o=e[Object.keys(e)[0]];return t.width<o.xLeft?(n.x=o.xLeft,n.labelLeft=!0):(n.x=o.xRight,n.labelLeft=!1),n}(n,l.rect);return l.yPos=function(e,t,n){function o(e){var n=[];return e.forEach(function(o,r){0!==r&&r!==e.length-1&&n.push(o.top+t/2)}),n}var r=function(e){var o=[],r={top:n,bottom:n+t};return o.push(r),e.forEach(function(e){r={top:e-t/2,bottom:e+t/2},o.push(r)}),r={top:0-t,bottom:0},o.push(r),o}(e);r=function(e){return e.forEach(function(t,n){if(0!==n&&n!==e.length-1){var o=e[n-1].top-t.bottom;o<0&&(t.top+=o,t.bottom+=o)}}),e}(r);var a=o(r);return a[a.length-1]<t/2&&(r=function(e){for(var t=e.length;t-- >0;)if(0!==t&&t!==e.length-1){var n=e[t+1].bottom-e[t].top;n>0&&(e[t].top+=n,e[t].bottom+=n)}return e}(r),a=o(r)),a}(s,l.rect.height,r),o.forEach(function(e,t){l[e].xLabel=c.x,l[e].labelLeft=c.labelLeft,l[e].yLabel=l.yPos[t],l[e].yDest=s[t],l[e].yTrans=l[e].yDest-l[e].yLabel,l[e].value=n[e].value}),l.lineX1=0,l.lineY1=0,l}function v(e,n,o,r){var a=e[Object.keys(e)[0]],s=a.xLabel;n.selectAll("g.tick").data(o,function(e){return e}).each(function(n){var o=t.select(this).attr("transform"),l=i(o)[1]+.5,c=e[n].yLabel-l;t.select(this).selectAll("text").transition(r).attr("transform",function(t){return"translate("+(e[t].labelLeft?s:s+e[t].textWidth)+", "+c+")"}).style("font-size","16px").attr("dy","0.35em").on("end",function(){t.select(this).text(function(t){return e[t].value})}),t.select(this).selectAll("line").transition(r).attr("x1",0).attr("y1",function(t){return.5+e[t].yTrans}).attr("x2",function(){return a.labelLeft?-6:6}).attr("transform",function(){return"translate("+s+", "+c+")"})}).exit().transition(r).style("opacity",0),n.selectAll("path.domain").transition(r).style("opacity",0)}function m(e,n,o){e.selectAll("g.tick").data(n,function(e){return e}).each(function(){t.select(this).selectAll("text").text(function(e){return e}).transition(o).attr("transform","translate(0, 0)").style("font-size","10px").attr("dy","0.32em"),t.select(this).selectAll("line").transition(o).attr("x1",0).attr("y1",.5).attr("x2",-6).attr("y2",.5).attr("transform","translate(0,0)")}).exit().transition(o).style("opacity",1),e.selectAll("path.domain").transition(o).style("opacity",1)}function k(e,n,o,r,a){var s=t.transition().duration(1e3),l=e.select("g.sankeyFrame.single"),u=l.select(".coverSankeySeq").node().getBBox().height;b(l.selectAll("g.links"),s),b(l.selectAll("g.node").filter(function(e){return e.nameX!==o}),s),b(l.selectAll("g.node").filter(function(e){return e.nameX===o}).filter(function(e){return-1===n().indexOf(e.nameY)}),s);var f=l.selectAll("g.node").filter(function(e){return e.nameX===o}).filter(function(e){return-1!==n().indexOf(e.nameY)}),d=0,h=0,g=[];n().forEach(function(e){g.push({name:e,value:0})});var p=0;f.each(function(e){g.forEach(function(t){t.name===e.nameY&&(t.value=e.value,p+=e.value)})}),g.forEach(function(e){h=e.value,e.value=d,d+=h});var m=t.scaleLinear().domain([0,p]).range([0,u-10]),k={},x={};f.transition(s).attr("transform",function(e){var n=i(t.select(this).attr("transform"))[0],o=0;return g.forEach(function(t){t.name===e.nameY&&(o=u-m(t.value+e.value),k[e.nameY]=o,x[e.nameY]=m(e.value))}),"translate ("+n+","+o+")"}),f.selectAll("rect.sankeyNode").transition(s).attr("height",function(e){return m(e.value)});var A=f.selectAll("rect.sankeyNodeInfo");A.classed("zoomed",!0).each(function(e){r.nodeInfoKeys.forEach(function(t){e.nodeInfos[t+"_transY"]=m(e.value-+e.nodeInfos[t]),e.nodeInfos[t+"_transHeight"]=m(+e.nodeInfos[t])})}),A.transition(s).attr("y",function(e){return e.nodeInfos[r.nodeInfoKey+"_transY"]}).attr("height",function(e){return e.nodeInfos[r.nodeInfoKey+"_transHeight"]});var w=i(f.attr("transform"))[0],L=+f.selectAll("rect").filter(function(e,t){return 0===t}).attr("width")+1,Y={},E={},O=n(),I=[];f.each(function(e){Y[e.nameY]=i(t.select(this).attr("transform"))[1],E[e.nameY]=c(""+e.value/e.valueXCorr,a,",.1%")}),O.forEach(function(e){f.filter(function(t){return t.nameY===e}).each(function(){return I.push(e)})});var N=e.selectAll("g.axis.left"),z=l.selectAll(".sankeySeq").node().getBBox().width,S=l.selectAll(".sankeySeq").node().getBBox().height,T={};I.forEach(function(e,t){T[e]={index:t,xLeft:w,xRight:w+L,yDest:k[e]+x[e]/2,value:E[e]+" "+e}}),v(y(e,T,I,S,z),N,I,s)}function x(e,n,o,r){var a=e.select("g.sankeyFrame.single"),s=t.transition().duration(1e3),l=e.selectAll("g.axis.left"),i=n(),c=[],u=a.selectAll("g.node").filter(function(){return!t.select(this).classed("hide")});u.each(function(e){-1!==i.indexOf(e.nameY)&&c.push(e.nameY)}),m(l,c,s),u.transition(s).attr("transform",function(e){return"translate ("+e.x+","+e.y+")"}),u.selectAll("rect.sankeyNode").transition(s).attr("height",function(e){return e.dy}),a.selectAll("rect.sankeyNodeInfo").classed("zoomed",!1).transition(s).attr("y",function(e){return e.dy-e.nodeInfos[r.nodeInfoKey+"_dy"]}).attr("height",function(e){return e.nodeInfos[r.nodeInfoKey+"_dy"]}),A(a.selectAll("g.links"),s),A(a.selectAll("g.node"),s)}function b(e,n){e.transition(n).style("opacity",0).on("end",function(){t.select(this).classed("hide",!0)})}function A(e,t){e.classed("hide",!1).transition(t).style("opacity",1)}function w(e,n,o,r,a){function s(e){var t=void 0;return"%sameTime"===r?t=c(""+e.value/e.valueXCorr,o,",.1%"):"%sameEvent"===r?t=c(""+e.value/e.valueY,o,",.1%"):"%prevEvent"===r?t=c(""+e.value/e.valueYPrev,o,",.1%"):"%firstEvent"===r&&(t=c(""+e.value/e.valueYFirst,o,",.1%")),t}var l=t.transition().duration(1e3),i=e.select("g.sankeyFrame.single"),u=e.select("g.sankeyFrame.single rect.sankeyNode").attr("width")/2;b(i.selectAll("g.links"),l),b(i.selectAll("g.node").filter(function(e){return e.nameY!==n}),l),i.selectAll("g.node").filter(function(e){return e.nameY===n}).append("text").attr("class","percentageLabel").attr("x",function(e){return(a===e.nameX?2:u)+"px"}).attr("y","-5px").text(s).style("text-anchor",function(e){return a===e.nameX?"left":"middle"}).transition(l).style("opacity",1)}function L(e){var n=e.select("g.sankeyFrame.single"),o=t.transition().duration(1e3);A(n.selectAll("g.links"),o),A(n.selectAll("g.node"),o),b(e.selectAll("text.percentageLabel"),o)}function Y(){function e(e){h.stop(),h={},c=[],e.select("div.sankeyChart canvas").remove()}function n(e,n,o,r,a,s,l,i,h,v){g=s,p=l,y=i,A=v,x=n,b=h,c.remove=-1,d=t.scaleLinear().domain([1,o]).range([r,a]),u=e.select("div.sankeyChart svg").attr("width"),f=e.select("div.sankeyChart svg").attr("height"),e.select("div.sankeyChart").insert("canvas",":first-child").attr("width",u).attr("height",f).attr("class","particles"),A&&(console.log("canvas (width, height): ("+u+", "+f+")"),console.log("canvas translate(x, y): ("+n.x+", "+n.y+")")),k=e.select("canvas").node().getContext("2d"),k.clearRect(0,0,u,f),k.translate(n.x,n.y),e.selectAll("g.sankeyFrame.single rect.sankeyNode").each(function(e){e.color=t.select(this).style("fill"),e.alpha=t.select(this).style("fill-opacity")})}function o(e,n,o,r,a){var s=void 0,l=[];v=n,m=e,m.forEach(function(e){var n=t.select(e).datum();o.forEach(function(o){o.sx===n.source.nameX&&o.sy===n.source.nameY&&o.tx===n.target.nameX&&o.ty===n.target.nameY&&(s={},s.freq=d(void 0===a?n.value:a),s.dy=n.dy,s.value=o.value,s.particleSize=2.5*y,s.particleColor=t.scaleLinear().domain([0,1]).range([n.source.color,n.target.color]),s.particleAlpha=t.scaleLinear().domain([0,1]).range([n.source.alpha,n.target.alpha]),s.sourceX=n.source.nameX,s.sourceY=n.source.nameY,s.svgPath=e,l.push(s))})});var i={};i.pathName=v,i.sequenceStart=r,i.links=l,i.particles=[],c.push(i)}function r(e){var t=0,n=Math.random(),o=-1;e.forEach(function(e){t+=e.value});for(var r=0;r<e.length;r++){if(r===e.length-1){o=r;break}if(n<e[r].value/t){o=r;break}n-=e[r].value/t}return o}function a(e){-1!==c.remove&&(c.splice(c.remove,1),c.remove=-1),c.forEach(function(t){t.particles.forEach(function(n){if(n.current>=n.path.getTotalLength()){if(n.needsNewLinkIndex){var o=t.links.filter(function(e){return n.path.__data__.target.nameX===e.sourceX&&n.path.__data__.target.nameY===e.sourceY});o.length>0&&(n.linkIndex=r(o),A&&console.log("linkIndex("+o.length+"): "+n.linkIndex),n.needsNewLinkIndex=!1)}t.links.filter(function(e){return n.path.__data__.target.nameX===e.sourceX&&n.path.__data__.target.nameY===e.sourceY}).forEach(function(t,o){o===n.linkIndex&&(n.current-n.path.getTotalLength()<=b?(n.current=0,n.diffToNextY=t.svgPath.getPointAtLength(0).y+n.offsetFactor*t.dy-(n.lastPosition.y+n.offsetFactor*n.link.dy),n.node=!0):(n.link=t,n.offset=n.offsetFactor*t.dy,n.current=0,n.time=e,n.path=t.svgPath,n.lastPosition=n.path.getPointAtLength(n.path.getTotalLength()),n.node=!1))})}else n.needsNewLinkIndex||(n.needsNewLinkIndex=!0)}),t.particles=t.particles.filter(function(e){return e.current<e.path.getTotalLength()}),t.links.filter(function(e){return t.sequenceStart===e.sourceX}).forEach(function(n){var o=Math.random()-.5;if(Math.random()<n.freq){var r=o*n.dy,a=n.svgPath.getPointAtLength(n.svgPath.getTotalLength());t.particles.push({link:n,time:e,offset:r,offsetFactor:o,path:n.svgPath,node:!1,lastPosition:a,diffToNextY:0,linkIndex:-1,needsNewLinkIndex:!0})}})}),s(e)}function s(e){k.clearRect(0,0,u,f),k.lineWidth="1px",c.forEach(function(t){var n=t.particles;for(var o in n){var r=e-n[o].time;n[o].current=r*g;var a,s;if(n[o].node){s=1,a=n[o].path.getPointAtLength(n[o].path.getTotalLength());var i=n[o].current-n[o].path.getTotalLength();a.x=a.x+i,a.y=a.y+i/b*n[o].diffToNextY}else a=n[o].path.getPointAtLength(n[o].current),s=n[o].current/n[o].path.getTotalLength();A&&(console.log("current Position: ("+a.x+", "+a.y+")"),console.log("current Position with offset ["+n[o].offset+"]: ("+a.x+", "+(a.y+n[o].offset)+")")),k.fillStyle=n[o].link.particleColor(s),k.globalAlpha=n[o].link.particleAlpha(s),"circle"===p?(k.beginPath(),k.arc(a.x,a.y+n[o].offset,n[o].link.particleSize,0,2*Math.PI),k.closePath(),k.fill()):"person"===p&&l(k,a.x,a.y+n[o].offset)}})}function l(e,t,n){var o=.05*y;e.translate(-653*o,-768*o),e.translate(t+x.x,n+x.y),e.scale(o,o),e.save(),e.translate(294.11,29.495),e.beginPath(),e.moveTo(315.67,347.53),e.bezierCurveTo(315.67,368.03299999999996,299.04900000000004,384.65299999999996,278.547,384.65299999999996),e.bezierCurveTo(258.04400000000004,384.65299999999996,241.42400000000004,368.032,241.42400000000004,347.53),e.bezierCurveTo(241.42400000000004,327.027,258.045,310.407,278.547,310.407),e.bezierCurveTo(299.05,310.407,315.67,327.02799999999996,315.67,347.53),e.closePath(),e.fill(),e.stroke(),e.restore(),e.stroke(),e.beginPath(),e.moveTo(516.35,490.41),e.bezierCurveTo(516.35,490.41,486.011,647.94,479.47900000000004,658.6),e.bezierCurveTo(473.89250000000004,667.7154,430.29900000000004,739.242,430.29900000000004,739.242),e.bezierCurveTo(420.99250000000006,754.502,429.81161000000003,765.4119999999999,439.67140000000006,771.1039999999999),e.bezierCurveTo(448.06520000000006,775.9495999999999,466.1084000000001,774.7497999999999,472.0744000000001,764.5739),e.bezierCurveTo(472.0744000000001,764.5739,520.4404000000001,689.3069,525.7174000000001,673.0739),e.bezierCurveTo(529.3708000000001,661.8359,537.8604000000001,615.2169,537.8604000000001,615.2169),e.bezierCurveTo(537.8604000000001,615.2169,584.8564000000001,663.6869,590.0034000000002,672.3599),e.bezierCurveTo(596.4910000000002,683.2929,608.5744000000002,759.5029000000001,608.5744000000002,759.5029000000001),e.bezierCurveTo(611.4642000000002,773.0629,624.3964000000002,777.4849,637.8604000000003,775.2169000000001),e.bezierCurveTo(648.4934000000003,773.4261000000001,659.6134000000003,766.2318000000001,657.1464000000003,753.0739000000001),e.bezierCurveTo(657.1464000000003,753.0739000000001,646.4004000000003,664.7139000000001,637.8604000000003,650.2139000000001),e.bezierCurveTo(627.6694000000002,632.9119000000001,572.8604000000003,573.7849000000001,572.8604000000003,573.7849000000001),e.lineTo(588.5744000000003,503.7849000000001),e.bezierCurveTo(588.5744000000003,503.7849000000001,598.6604000000003,524.2309000000001,605.7174000000003,533.0709000000002),e.bezierCurveTo(613.7429000000003,543.1239000000002,664.2884000000004,572.3569000000002,664.2884000000004,572.3569000000002),e.bezierCurveTo(668.9247000000004,575.4666000000002,679.4214000000004,573.7531000000002,683.5744000000004,565.9283000000003),e.bezierCurveTo(686.9076000000005,559.6477000000002,686.7507000000004,549.4743000000003,679.2887000000004,544.4993000000003),e.bezierCurveTo(679.2887000000004,544.4993000000003,637.6337000000004,518.3483000000003,627.8597000000004,510.2133000000003),e.bezierCurveTo(616.9897000000004,501.1833000000003,594.9997000000004,440.9433000000003,594.9997000000004,440.9433000000003),e.bezierCurveTo(588.1789000000005,431.5569000000003,578.8487000000005,421.2013000000003,562.8567000000004,420.9433000000003),e.bezierCurveTo(546.7377000000004,420.6830200000003,538.6697000000004,429.5629000000003,531.4277000000004,434.51430000000033),e.bezierCurveTo(531.4277000000004,434.51430000000033,469.6807000000004,479.61930000000035,463.57070000000044,488.80030000000033),e.bezierCurveTo(457.4238000000004,498.0363000000003,446.4277000000004,567.3713000000004,446.4277000000004,567.3713000000004),e.bezierCurveTo(444.70410000000044,575.2713000000003,447.7898000000004,581.6243000000004,457.1417000000004,583.8003000000003),e.bezierCurveTo(468.5847000000004,586.4623000000004,476.7867000000004,579.3369000000004,477.8557000000004,573.8003000000003),e.bezierCurveTo(477.8557000000004,573.8003000000003,484.9065000000004,519.0353000000003,489.99870000000044,510.94330000000036),e.bezierCurveTo(495.92750000000046,501.52190000000036,516.3447000000004,490.42230000000035,516.3447000000004,490.42230000000035),e.closePath(),e.fill(),e.stroke(),e.setTransform(1,0,0,1,0,0)}var i=function(){},c=[],u=void 0,f=void 0,d=void 0,h={},g=void 0,p=void 0,y=void 0,v=void 0,m=void 0,k=void 0,x=void 0,b=void 0,A=void 0;return i.init=function(e,t,r,a,s,l,u,f,d,h,g,p,y,v,m){0===e.select("div.sankeyChart").selectAll("canvas").size()&&n(e,r,u,d,h,g,p,y,v,m);var k=!1;return c.forEach(function(e){e.pathName===a&&(k=!0)}),k||o(t,a,s,l,f),i},i.start=function(){return 0===Object.keys(h).length&&(h=t.timer(a)),i},i.stop=function(t,n){void 0===n&&e(t);var o=!1,r=-1;return c.forEach(function(e,t){e.pathName===n&&(o=!0,r=t)}),o&&(1===c.length?e(t):c.remove=r),i},i}function E(e){function n(t){t.each(function(n){console.log(n),console.log("_myData "+e),void 0!==n?A(t,n):"object"==(void 0===e?"undefined":O(e))?z(e,t):void 0!==e?E(e,t):E("<pre>",t)})}function o(e){var t=e.append("div").attr("class","sankeyMenu"),n=t.append("div").attr("class","OptionsMenu");if(n.append("div").attr("class","titleMenu").append("label").text("options"),1!==K.cols||1!==K.rows){n.append("span").attr("class","span1").append("input").attr("class","nodeScaling").attr("type","checkbox").on("change",function(t){v(e)}).node().checked=M,n.select("span.span1").append("label").text("global scale"),n.append("br")}if(n.append("span").attr("class","span2").append("input").attr("class","labelOnOff").attr("type","checkbox").on("change",function(){m(e)}).node().checked=j,t.select("span.span2").append("label").text("node labels"),void 0!==X){ee&&(console.log("nodeInfoKeys: "),console.log(P));var o=e.select("div.sankeyMenu").append("div").attr("class","NodeInfoMenu");o.append("div").attr("class","titleMenu").append("label").text("node info"),o=o.append("form").selectAll("span").data(P).enter().append("span"),o.append("input").attr("type","radio").attr("name","menu").attr("value",function(e){return e}).attr("checked",function(e,t){if(0===t)return"checked"}).on("change",function(){q=this.value,F.nodeInfoKey=q,console.log("nodeInfokey: "+q),b(e)}),o.append("label").text(function(e){return e}),o.append("br")}}function r(e){if(void 0!==C){if(0===e.select("div.PathsMenu").size()){var n=void 0,o=void 0,r=void 0,a=void 0,s=f(e);if(o=K[s.col][s.row].dimCol,n=K[s.col][s.row].dimRow,""===o&&(o=0),""===n&&(n=0),8===Object.keys(C[0]).length){var l=Object.keys(C[0])[5],i=Object.keys(C[0])[6];r=t.nest().key(function(e){return e[l]}).key(function(e){return e[i]}).key(function(e){return e.name}).object(C)}else if(7===Object.keys(C[0]).length){var c=Object.keys(C[0])[5];r=t.nest().key(function(e){return e[c]}).key(function(){return 0}).key(function(e){return e.name}).object(C)}else 6===Object.keys(C[0]).length?r=t.nest().key(function(){return 0}).key(function(){return 0}).key(function(e){return e.name}).object(C):console.log("Error with number of attributes in paths file!");if(void 0===r[n])return;if(void 0===r[n][o])return;a=Object.keys(r[n][o]),ee&&(console.log("pathFile: "),console.log(C));var u=e.select("div.sankeyMenu").append("div").attr("class","PathsMenu").style("opacity",0);u.append("div").attr("class","titleMenu").append("label").text("show path");var d=u.selectAll("span").data(a).enter().append("span");d.append("input").attr("class","pathInfo").attr("type","checkbox").attr("value",function(e){return e}).on("change",function(t){y.call(this,e,t)}),d.append("label").text(function(e){return e}),d.append("br")}var h=t.transition().duration(1e3);e.select("div.PathsMenu").transition(h).style("opacity",1)}}function a(e){var n=t.transition().duration(1e3);e.select("div.PathsMenu").transition(n).style("opacity",0),e.selectAll("canvas.particles").remove()}function y(e,n){if(t.select(this).node().checked){if(0===e.select("g.sankeyFrame.single").size())return;var o,r,a=f(e),s=a.col,l=a.row,i=e.select("g.sankeyFrame.single").attr("class").split(" ")[1],c=[],u=ae.length-1,d=K[s][l].sankey;M?d.maxValue(K.maxValue):d.maxValue(-1),C.forEach(function(e){e.name===n&&(c.push({sx:e.sourceX,sy:e.sourceY,tx:e.targetX,ty:e.targetY,value:+e.value}),r||(r=+e.value),ae.indexOf(e.sourceX)<u&&(u=ae.indexOf(e.sourceX)))}),o=ae[u],ee&&(console.log(c),console.log(r)),$=$.init(e,Z.get(i),U.particleStart,n,c,o,d.maxValue(),r,he,ge,pe,ve,ye,te,ee).start()}else $=$.stop(e,n),console.log("stopped!")}function v(e){var n,o,r,a=t.transition().duration(1e3);M=e.select(".nodeScaling").node().checked,K.forEach(function(s,l){s.forEach(function(s,c){n=s.sankey,r=s.graph,M?n.maxValue(K.maxValue):n.maxValue(-1),n.layout(),o="g.sankeySeq.s"+l+"-"+c,e.select(o).selectAll(".link").data(r.links,function(e){return e.id}).transition(a).attr("d",n.link()).style("stroke-width",function(e){return Math.max(1,e.dy)+"px"}),e.select(o).selectAll(".node").data(r.nodes).transition(a).attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),e.select(o).selectAll("rect.sankeyNode").transition(a).attr("height",function(e){return e.dy}),e.select(o).selectAll("text.nodeLabel").transition(a).attr("y",function(e){if(ee){var n=i(t.select(this.parentNode).attr("transform"))[1];console.log("transform: "+t.select(this.parentNode).attr("transform")),console.log(n)}var o=parseInt(t.select(this).style("font-size"));return e.dy<o?e.dy-o/2-2:Math.min(e.dy/2,e.dy-o/2-2)}),e.select(o).selectAll("rect.sankeyNodeInfo").filter(function(t){return P.forEach(function(o){o!==_?t.nodeInfos[o+"_dy"]=n.getNodeHeight(+t.nodeInfos[o]):q===_&&e.selectAll("rect.sankeyNodeInfo").attr("y",function(e){return e.dy})}),void 0!==t.nodeInfos}).attr("height",function(){return t.select(this).attr("height")}).transition(a).attr("y",function(e){return q===_?e.dy:(ee&&(console.log("value: "+ +e.nodeInfos[q]),console.log("newHeight: "+e.nodeInfos[q+"_dy"])),e.dy-e.nodeInfos[q+"_dy"])}).attr("height",function(e){return q===_?0:e.nodeInfos[q+"_dy"]})})})}function m(e){e.selectAll("text.nodeLabel").style("display",function(){return e.select(".labelOnOff").node().checked?"block":"none"})}function b(e){var n=t.transition().duration(1e3),o=e.select("rect.sankeyNodeInfo").style("fill"),r=t.color(o).rgb();r.opacity=.1,e.select("div.NodeInfoMenu").transition(n).style("border-color",function(){return q===_?"rgba(0,0,0,0.1)":o}).style("background-color",function(){return q===_?"rgba(0,0,0,0.1)":r.toString()}),e.selectAll("rect.sankeyNodeInfo").style("display","inline").transition(n).attr("y",function(e){return t.select(this).classed("zoomed")?e.nodeInfos[q+"_transY"]:e.dy-e.nodeInfos[q+"_dy"]}).attr("height",function(e){return t.select(this).classed("zoomed")?e.nodeInfos[q+"_transHeight"]:e.nodeInfos[q+"_dy"]}).transition().delay(10).duration(10).style("display",function(){return q===_?"none":"inline"})}function A(e){var i,u,f,y,v,b,A,Y,E;e.each(function(){var e=t.select(this);o(e),E=e.append("div").attr("class","sankeyChart").append("svg").attr("width",oe[0]).attr("height",oe[1]).append("g").attr("transform","translate("+re.left+","+re.top+")"),U=d(E,oe,re,se,ae,te),1===K.cols&&1===K.rows&&(e.selectAll(".axis").style("opacity",1),e.selectAll(".sankeyNode,.sankeyNodeInfo").style("stroke-width","1px"),e.select("g.sankeyFrame").classed("single",!0),G=R),u=U.width,f=U.height,ee&&(console.log("allGraphs:"),console.log(K)),K.forEach(function(o,d){o.forEach(function(o,O){function I(t){var n=G===D||G===J,o=e.select("g.sankeyFrame.single").selectAll("g.node").filter(function(e){return e.nameX===t}),r=0===o.size(),a=o.filter(function(e){return-1!==ce().indexOf(e.nameY)}).size(),s=0===a;return n||r||s}function N(e){var t=e(),n=t.sort(function(e,t){return se.indexOf(e)-se.indexOf(t)});e=function(){return n}}function z(t){var n=G===D||G===J,o=e.select("g.sankeyFrame.single").selectAll("g.node").filter(function(e){return e.nameY===t}).size(),r=0===o,a="%sameTime"===V[0]&&-1===ce().indexOf(t);return n||r||a}A=o.graph,ee&&(console.log("col: "+o.dimCol),console.log("row: "+o.dimRow)),i=s().size([u,f]).sequence(ae).categories(se).nodeWidth(te).nodePadding(ne).nodes(A.nodes).links(A.links).correspondingCategories(n.correspondingEvents()).debugOn(ee),M&&i.maxValue(K.maxValue),i.layout().addValues(),o.sankey=i,Y=h(E,U,K,d,O),e.select("div.sankeyChart > svg").on("click",function(){if(G===J){e.select(".nodeScaling").size>0&&(e.select(".nodeScaling").node().disabled=!1),e.select(".labelOnOff").node().disabled=!1;var t=e.select("g.zoomed").classed("zoomed",!1).datum();x(e,ce,t,F),r(e),G=R
}else G===D&&(e.select(".nodeScaling").size>0&&(e.select(".nodeScaling").node().disabled=!1),e.select(".labelOnOff").node().disabled=!1,e.select("g.zoomed").classed("zoomed",!1),L(e),r(e),G=R)}),v=E.append("g").datum(Y.sankeyFrame).attr("class",function(){var e="sankeyFrame f"+d+"-"+O;return e+=1===K.cols&&1===K.rows?" single":" multiples"}).attr("transform",Y.sankeyFrame.multiples).on("click",function(){1===K.cols&&1===K.rows||(G===H?(g(E,this),r(e),G=R):G===R&&(p(E,this),a(e),G=H))}),y=v.append("g").datum(Y.sankeySeq).attr("class","sankeySeq s"+d+"-"+O).attr("transform",Y.sankeySeq.multiples);var S=v.append("g").datum(Y.pTop).attr("class","sankeyPad multiples pTop").attr("transform",Y.pTop.multiples);S.append("text").attr("class","multiples col c"+d).text(function(){return 1===K.cols&&K.rows>1?o.dimRow:o.dimCol}),S.append("text").attr("class","single col c"+d).style("opacity",0).text(function(){return 1===K.cols&&K.rows>1?o.dimRow:o.dimRow+"    "+o.dimCol}),v.append("g").datum(Y.pLeft).attr("class","sankeyPad multiples pLeft").attr("transform",Y.pLeft.multiples).append("text").attr("class","multiples row r"+O).attr("transform","rotate(-90)").text(function(){var e="";return K.cols>1&&K.rows>1&&(e=o.dimRow),e}),y.append("rect").attr("class","coverSankeySeq").attr("height",f).attr("width",u+2).style("stroke","black").style("stroke-width",1).style("fill-opacity",0),W=t.select("body").append("div").attr("class","tooltipSankeySeq"),y.append("g").attr("class","links").selectAll(".link").data(A.links).enter().append("path").attr("class",function(e){return"link lsx"+e.source.nameX.replace(/ /g,"_")+" lsy"+e.source.nameY.replace(/ /g,"_")+" ltx"+e.target.nameX.replace(/ /g,"_")+" lty"+e.target.nameY.replace(/ /g,"_")}).attr("d",i.link()).style("stroke-width",function(e){return Math.max(1,e.dy)+"px"}).sort(function(e,t){return t.dy-e.dy}).each(function(e,t,n){0===t&&(Q=[]),Q.push(this),t===n.length-1&&Z.set("f"+d+"-"+O,Q)}).on("mouseover",function(e){var t=ue+": "+e.source.nameX+" ⇾ "+e.target.nameX;t+="<br>"+fe+": "+e.source.nameY+" ⇾ "+e.target.nameY,t+="<br>"+B+": "+c(e.value,de,",.0f"),null!=e.additionalLabel&&(t+="<br>"+e.additionalLabel),W.html(t),W.style("visibility","visible")}).on("mousemove",function(){var e=19,n=19,o=W.style("width").indexOf("px");-1!=o&&(e+=+W.style("width").substr(0,o)),-1!=(o=W.style("height").indexOf("px"))&&(n+=+W.style("height").substr(0,o));var r=t.event.pageY-100<0?t.event.pageY+23:t.event.pageY-n,a=t.event.pageX+250<window.innerWidth?t.event.pageX+5:t.event.pageX-e;return W.style("top",r+"px").style("left",a+"px")}).on("mouseout",function(){return W.style("visibility","hidden")}),b=y.append("g").attr("class","nodes").selectAll(".node").data(A.nodes).enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),b.append("rect").attr("class",function(e){var t="sankeyNode nx"+e.nameX.replace(/ /g,"_")+" ny"+e.nameY.replace(/ /g,"_");return se.forEach(function(n,o){n===e.nameY&&(t+=" color"+o%5)}),t}).attr("height",function(e){return e.dy}).attr("width",i.nodeWidth()).on("mouseover",function(e){var t=ue+": "+e.nameX;t+="<br>"+fe+": "+e.nameY,t+="<br>"+B+": "+c(e.value,de,",.0f"),V.forEach(function(n){"%sameTime"===n?ce().length===se.length?t+="<br>% of '"+e.nameX+"': "+c(""+e.value/e.valueX,de,",.1%"):t+="<br>% of '"+e.nameX+"'(CE): "+c(""+e.value/e.valueXCorr,de,",.1%"):"%sameEvent"===n?t+="<br>% of '"+e.nameY+"': "+c(""+e.value/e.valueY,de,",.1%"):"%prevEvent"===n?t+="<br>% of previous '"+e.nameY+"': "+c(""+e.value/e.valueYPrev,de,",.1%"):"%firstEvent"===n&&(t+="<br>% of first '"+e.nameY+"': "+c(""+e.value/e.valueYFirst,de,",.1%"))}),W.html(t),W.style("visibility","visible")}).on("mousemove",function(){l(W)}).on("mouseout",function(){return W.style("visibility","hidden")}),b.append("text").attr("class","nodeLabel").style("display",function(){return e.select(".labelOnOff").node().checked?"block":"none"}).attr("x",3+i.nodeWidth()).attr("y",function(e){return e.dy/2}).attr("dy",".35em").attr("text-anchor","start").attr("transform",null).style("opacity",0).text(function(e){return e.nameY}).each(function(){ee&&(console.log(t.select(this.parentNode).node()),console.log("transform: "+t.select(this.parentNode).attr("transform")));var e=parseInt(t.select(this).style("font-size"));t.select(this).attr("y",function(t){return t.dy<e?t.dy-e/2-2:Math.min(t.dy/2,t.dy-e/2-2)})}).filter(function(e){return e.x>.9*u}).attr("x",-3).attr("text-anchor","end"),b.filter(function(e){return void 0!==e.nodeInfos}).append("rect").attr("class","sankeyNodeInfo").attr("y",function(e){return e.dy}).attr("height",function(e){return P.forEach(function(t){e.nodeInfos[t+"_dy"]=i.getNodeHeight(+e.nodeInfos[t])}),0}).attr("width",i.nodeWidth()).style("display",function(){return q===_?"none":"inline"}).on("mouseover",function(e){var t=ue+": "+e.nameX;t+="<br>"+fe+": "+e.nameY,t+="<br>"+B+" ("+q+"): "+c(e.nodeInfos[q],de,",.0f"),t+="<br>% of node: "+c(""+e.nodeInfos[q]/e.value,de,",.1%"),W.html(t),W.style("visibility","visible")}).on("mousemove",function(){l(W)}).on("mouseout",function(){return W.style("visibility","hidden")}),"single"===o.transform&&g(E,v.node(),t.transition().duration(0)),1===K.cols&&1===K.rows&&r(e),e.selectAll("g.axis.bottom > g.tick").on("click",function(n){if(G===R){if(I(n))return;e.select(".nodeScaling").size>0&&(e.select(".nodeScaling").node().disabled=!0),e.select(".labelOnOff").node().checked=!1,m(e),e.select(".labelOnOff").node().disabled=!0,t.select(this).classed("zoomed",!0),N(ce),a(e),k(e,ce,n,F,de),t.event.stopPropagation(),G=J}}),e.selectAll("g.axis.bottom > g.tick").on("mouseover",function(e){if(I(e))return void t.select(this).style("cursor","default");t.select(this).style("cursor","pointer");var n=t.select(this).selectAll("text").node().getBBox(),o=n.width/2+2,r=n.height,a="M0.5 0 L"+-(.5+o+3)+" 8 L"+-(.5+o)+" 8 L"+-(.5+o)+" "+(r+11);a+=" L"+(.5+o)+" "+(r+11)+" L"+(.5+o)+" 8 L"+(.5+o+3)+" 8 Z",t.select(this).selectAll("path").data([e],function(e){return e}).enter().append("path").attr("d",a)}).on("mouseleave",function(){t.select(this).selectAll("path").remove(),t.select(this).style("cursor","default")}),e.selectAll("g.axis.left > g.tick").on("click",function(n){if(G===R){if(z(n))return;t.select(this).classed("zoomed",!0),e.select(".nodeScaling").size>0&&(e.select(".nodeScaling").node().disabled=!0),e.select(".labelOnOff").node().checked=!1,m(e),e.select(".labelOnOff").node().disabled=!0,a(e),w(e,n,de,V[0],ae[0]),t.event.stopPropagation(),G=D}}),e.selectAll("g.axis.left > g.tick").on("mouseover",function(e){if(z(e))return void t.select(this).style("cursor","default");t.select(this).style("cursor","pointer");var n=t.select(this).selectAll("text").node().getBBox(),o=n.width,r=n.y+n.height/2,a=n.height/2+2,s="M0 "+r+" L-10 "+(r+a+3)+" L-10 "+(r+a)+" L"+-(o+12)+" "+(r+a);s+=" L"+-(o+12)+" "+(r-a)+" L-10 "+(r-a)+" L-10 "+(r-a-3)+" Z",t.select(this).selectAll("path").data([e],function(e){return e}).enter().append("path").attr("d",s)}).on("mouseleave",function(){t.select(this).selectAll("path").remove(),t.select(this).style("cursor","default")})})})})}function E(e,n){if("<pre>"!==e){var o=e.split(".")[e.split(".").length-1];"csv"!==o&&"json"!==o?console.log("Wrong suffix (neither csv nor json): "+e):"json"===o?N(e,n):I(e,n)}else{if(0!==t.select("pre#data").size()?T=t.csvParse(t.select("pre#data").text()):console.log("no data found in pre#data!"),0!==t.select("pre#dataNodes").size()){var r=t.select("pre#dataNodes").text();""!==r&&(X=t.csvParse(r))}if(0!==t.select("pre#paths").size()){var a=t.select("pre#paths").text();""!==a&&(C=t.csvParse(a))}ee&&(console.log("file: "),console.log(T),console.log("nodeFile: "),console.log(X)),ee&&(console.log("file: "),console.log(T),console.log("pathFile: "),console.log(C)),K=S(T),A(n)}}function I(e,n){t.csv(e,function(o,r){var a=e.slice(0,e.lastIndexOf("."))+"_nodes"+e.slice(e.lastIndexOf("."));t.csv(a,function(o,s){ee&&(console.log("start"),console.log(o),console.log(s),console.log("end")),X=s,T=r,ee&&(console.log("file: "),console.log(T),console.log("nodeFileName: "),console.log(a),console.log("nodeFile: "),console.log(X));var l=e.slice(0,e.lastIndexOf("."))+"_paths"+e.slice(e.lastIndexOf("."));t.csv(l,function(e,t){C=t,ee&&(console.log("pathfile error:"),console.log(e),console.log("pathfile:"),console.log(C),console.log("end")),K=S(T),A(n)})})})}function N(e,n){t.json(e,function(e,t){ee&&(console.log("start"),console.log(e),console.log(t),console.log("end")),z(t,n)})}function z(e,t){e.data?(T=e.data,T.columns=Object.keys(T[0])):console.log(" --\x3e No data key found in JSON file"),e.dataNodes?(X=e.dataNodes,X.columns=Object.keys(X[0])):console.log(" --\x3e No dataNodes key found in JSON file"),e.paths?(C=e.paths,C.columns=Object.keys(C[0])):console.log(" --\x3e No paths key found in JSON file"),K=S(T),A(t)}function S(e){var n,o,r,a,s,l,i,c,f={},d=[],h=e.columns,g=[],p=t.map(),y=0,v=t.set(),m=t.set();console.log(e.columns),void 0===B&&(B=e.columns[0]),5===e.columns.length?(g=t.nest().key(function(){return""}).key(function(){return""}).entries(e),void 0!==X&&(X.forEach(function(e){r=e.sourceX+","+e.sourceY,p.set(r,e),ee&&console.log(e)}),P=X.columns,P.splice(0,2,_))):6===e.columns.length?(g=t.nest().key(function(){return""}).key(function(e){return e[h[5]]}).sortKeys(u(ie)).entries(e),void 0!==X&&(X.forEach(function(t){r=t[e.columns[5]]+","+t.sourceX+","+t.sourceY,p.set(r,t),ee&&console.log(t)}),P=X.columns,P.splice(0,3,_))):e.columns.length>=7&&(g=t.nest().key(function(e){return e[h[6]]}).sortKeys(u(le)).key(function(e){return e[h[5]]}).sortKeys(u(ie)).entries(e),ee&&console.log("----------- nodeInfos ------------"),void 0!==X&&(X.forEach(function(t){r=t[e.columns[6]]+","+t[e.columns[5]]+","+t.sourceX+","+t.sourceY,p.set(r,t),ee&&console.log(t)}),P=X.columns,P.splice(0,4,_))),d.rows=t.nest().key(function(e){return e[h[5]]}).entries(e).length,d.cols=t.nest().key(function(e){return e[h[6]]}).entries(e).length,ee&&(console.log("----------- datagroups ------------"),console.log(g),console.log("----------nodeMap----------"),console.log(p)),g.forEach(function(e,r){d[r]=[],e.values.forEach(function(u){a=u.values,f={nodes:[],links:[]},ee&&console.log("graph0: "),a.forEach(function(e,t){ee&&(console.log("i: "+t),console.log(e)),n=e[h[1]]+"_"+e[h[2]],o=e[h[3]]+"_"+e[h[4]],f.nodes.push({name:n}),f.nodes.push({name:o}),f.links.push({source:n,target:o,id:n+"->"+o,value:+e[h[0]],additionalLabel:e[h[7]]}),v.add(e[h[1]]),v.add(e[h[3]]),m.add(e[h[2]]),m.add(e[h[4]])}),ee&&(console.log("graph1: "),console.log(JSON.stringify(f))),f.nodes=t.nest().key(function(e){return e.name}).map(f.nodes).keys(),ee&&(console.log("graph2: "),console.log(JSON.stringify(f))),f.links.forEach(function(e,t){f.links[t].source=f.nodes.indexOf(f.links[t].source),f.links[t].target=f.nodes.indexOf(f.links[t].target)}),f.nodes.forEach(function(t,n){var o=t.split("_")[0],r=t.split("_")[1];f.nodes[n]={name:t,nameX:o,nameY:r};var a,s=""===e.key?"":e.key+",",l=""===u.key?"":u.key+",";void 0!==(a=p.get(s+l+o+","+r))&&(Object.keys(a).forEach(function(e){a[e+"_dy"]=0}),a[_]=0,f.nodes[n].nodeInfos=a)}),ee&&(console.log("graph 3"),console.log(JSON.stringify(f)),console.log(f)),ee&&(console.log("categoriesSorted: "),console.log(se)),s={},s.graph=f,s.dimRow=u.key,s.dimCol=e.key,l=t.nest().key(function(e){return e.source}).rollup(function(e){return t.sum(e,function(e){return+e.value})}).entries(f.links),i=t.nest().key(function(e){return e.target}).rollup(function(e){return t.sum(e,function(e){return+e.value})}).entries(f.links),l=l.concat(i),c=t.max(l,function(e){return e.value}),y=c>y?c:y,1===d.cols&&1===d.rows?s.transform="single":s.transform="multiples",d[r].push(s)})}),F.nodeInfoKeys=P,F.nodeInfoNone=_,F.nodeInfoKey=q;var k=v.values().sort(t.ascending),x=m.values().sort(t.ascending);return console.log(" data sequence: "+k),ae?console.log("input sequence: "+ae):ae=k,console.log(" data categories: "+x),se?console.log("input categories: "+se):se=x,ee&&console.log("maxValue: "+y),d.maxValue=y,d}var T=void 0,X=void 0,C=void 0,P=void 0,_="(none)",q=_,F={},B=void 0,M=!0,j=!0,V=["%sameTime"],K=void 0,W=void 0,R=1,H=2,J=3,D=4,G=H,Z=t.map(),Q=void 0,U=void 0,$=Y(),ee=!1,te=15,ne=8,oe=[700,500],re={left:5,top:5,right:5,bottom:5},ae=void 0,se=void 0,le=void 0,ie=void 0,ce=function(){return se},ue="sequence",fe="category",de=",",he=.05,ge=.5,pe=.1,ye=1,ve="circle",me=["circle","person"];return n.debugOn=function(e){return arguments.length?(ee=e,n):ee},n.size=function(e){return arguments.length?(oe=e,n):oe},n.margin=function(e){return arguments.length?(re.left=e,re.top=e,re.right=e,re.bottom=e,n):re},n.nodeWidth=function(e){return arguments.length?(te=+e,n):te},n.nodePadding=function(e){return arguments.length?(ne=+e,n):ne},n.sequenceOrder=function(e){return arguments.length?(ae=e,n):ae},n.eventOrder=function(e){return arguments.length?(se=e,n):se},n.sequenceName=function(e){return arguments.length?(ue=e,n):ue},n.eventName=function(e){return arguments.length?(fe=e,n):fe},n.valueName=function(e){return arguments.length?(B=e,n):B},n.thousandsSeparator=function(e){return arguments.length?(de=e,n):de},n.scaleGlobal=function(e){return arguments.length?(M=e,n):M},n.showNodeLabels=function(e){return arguments.length?(j=e,n):j},n.percentages=function(e){return arguments.length?(V=e,n):V},n.rowOrder=function(e){return arguments.length?(ie=e,n):ie},n.colOrder=function(e){return arguments.length?(le=e,n):le},n.particleMin=function(e){return arguments.length?(he=e,n):he},n.particleMax=function(e){return arguments.length?(ge=e,n):ge},n.particleSpeed=function(e){return arguments.length?(pe=e,n):pe},n.particleSize=function(e){return arguments.length?(ye=e,n):ye},n.particleShape=function(e){return arguments.length?(-1!==me.indexOf(e)&&(ve=e),n):ve},n.correspondingEvents=function(e){return arguments.length?(ce=function(){return e},n):ce()},n}var O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,r){var l={key:e,arg:t,resolve:n,reject:r,next:null};s?s=s.next=l:(a=s=l,o(e,t))})}function o(n,a){try{var s=t[n](a),l=s.value;l instanceof e?Promise.resolve(l.value).then(function(e){o("next",e)},function(e){o("throw",e)}):r(s.done?"return":"normal",s.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?o(a.key,a.arg):s=null}var a,s;this._invoke=n,"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}();e.chart=E,Object.defineProperty(e,"__esModule",{value:!0})});