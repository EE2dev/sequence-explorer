var sequenceExplorerChart=function(a){"use strict";function w(b){b.each(function(c){console.log(c),console.log("_myData "+a),void 0!==c?E(b,c):void 0!==a?I(a,b):I("<pre>",b)})}function x(a){var b=o[0]-p.left-p.right,c=o[1]-p.bottom-p.top,d={left:0,bottom:0,right:0,top:20},e={left:20,bottom:0,right:0,top:20},f=a.append("g").attr("class","dummy d1").style("opacity",0).call(d3.axisLeft(d3.scalePoint().domain(r))),g=a.append("g").attr("class","dummy d2").style("opacity",0).call(d3.axisBottom(d3.scalePoint().domain(q)));d.left=f.node().getBBox().width,d.bottom=g.node().getBBox().height,b-=d.left,c=c-d.bottom-e.top,d3.selectAll("g.dummy").remove();var h=d3.scalePoint().domain(r).range([c,c/r.length]),i=d3.axisLeft(h),j=a.append("g").attr("class","axis left").style("opacity",0).call(i);d.left=j.node().getBBox().width,j.attr("transform","translate("+(d.left-1.5)+", "+d.top+")"),d3.selectAll("g.axis.left text").attr("dy","");var k=d3.scalePoint().domain(q).range([0,b-m]),l=d3.axisBottom(k),j=a.append("g").attr("class","axis bottom").style("opacity",0).call(l);d.bottom=j.node().getBBox().height,j.attr("transform","translate("+d.left+", "+(c+e.top)+")");var n={};return n.paddingSingle=d,n.paddingMultiples=e,n.width=b,n.height=c,n}function y(a,b,c,d,e){var f=b.width,g=b.height,h=b.paddingMultiples,i=d*f/c.cols,j=e*g/c.rows,k=(1/c.cols*f-h.left)/f,l=(1/c.rows*g-h.top)/g;k>=l?k=l:l=k;var m={};return m.sankeyFrame={},m.sankeyFrame.single="translate("+(i+f/2*k)+", "+(j+g/2*l)+") scale(0.05)",m.sankeyFrame.multiples="translate("+i+", "+j+") ",m.sankeySeq={},m.sankeySeq.single="translate("+b.paddingSingle.left+", 20)",m.sankeySeq.multiples="translate("+h.left+", "+h.top+") scale("+k+", "+l+")",m.pTop={},m.pTop.single="translate("+(h.left+f/2)+", "+(h.top-3)+")",m.pTop.multiples="translate("+(h.left+f/2*k)+", "+(h.top-3)+")",m.pLeft={},m.pLeft.single="translate("+(h.left-3)+", "+(h.top+g/2)+")",m.pLeft.multiples="translate("+(h.left-3)+", "+(h.top+g/2*l)+")",m}function z(a,b){var c=void 0!==b?b:d3.transition().duration(1e3);return d3.selectAll("g.sankeyFrame").each(function(b){this===a?(console.log("clicked"),d3.select(this).transition(c).attr("transform","translate(0, 0)"),d3.select(this).selectAll("g.pTop").transition(c).attr("transform",function(a){return a.single}),d3.select(this).selectAll("text.col.multiples").transition(c).style("opacity",0),d3.select(this).selectAll("text.col.single").transition(c).style("opacity",1),d3.select(this).selectAll("text.nodeLabel").transition(c).style("opacity",1),d3.select(this).selectAll("g.pLeft").transition(c).style("opacity",0),d3.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(c).style("stroke-width","1px"),d3.select(this).selectAll("g.sankeySeq").transition(c).attr("transform",function(a){return a.single}),d3.selectAll(".axis").transition().delay(800).style("opacity",1),d3.selectAll(".coverSankeySeq").transition(c).style("opacity",0)):(console.log("not clicked"),d3.select(this).transition(c).attr("transform",function(a){return a.single}).style("opacity",0),d3.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(c).style("stroke-width","1px"))}),!1}function A(a){var b=d3.transition().duration(1e3);return d3.selectAll("g.sankeyFrame").each(function(c){this===a?(console.log("clicked"),d3.select(this).transition(b).attr("transform",function(a){return a.multiples}),d3.select(this).selectAll("g.pTop").transition(b).attr("transform",function(a){return a.multiples}),d3.select(this).selectAll("text.col.multiples").transition(b).style("opacity",1),d3.select(this).selectAll("text.col.single").transition(b).style("opacity",0),d3.select(this).selectAll("text.nodeLabel").transition(b).style("opacity",0),d3.select(this).selectAll("g.pLeft").transition(b).style("opacity",1),d3.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(b).style("stroke-width","0px"),d3.select(this).selectAll("g.sankeySeq").transition(b).attr("transform",function(a){return a.multiples}),d3.selectAll(".axis").transition(b).style("opacity",0),d3.selectAll(".coverSankeySeq").transition(b).style("opacity",1)):(d3.select(this).transition(b).attr("transform",function(a){return a.multiples}).style("opacity",1),d3.select(this).selectAll(".sankeyNode,.sankeyNodeInfo").transition(b).style("stroke-width","0px"))}),!0}function B(a){var b=a.append("div").attr("class","sankeyMenu"),e=b.append("div").attr("class","OptionsMenu");if(e.append("div").attr("class","titleMenu").append("label").text("options"),1!==j.cols||1!==j.rows){e.append("span").attr("class","span1").append("input").attr("class","nodeScaling").attr("type","checkbox").on("change",C).node().checked=h,e.select("span.span1").append("label").text("global scale"),e.append("br")}if(e.append("span").attr("class","span2").append("input").attr("class","labelOnOff").attr("type","checkbox").on("change",D).node().checked=i,b.select("span.span2").append("label").text("node labels"),void 0!==c){l&&(console.log("nodeInfoKeys: "),console.log(d));var m=d3.select("div.sankeyMenu").append("div").attr("class","NodeInfoMenu");m.append("div").attr("class","titleMenu").append("label").text("node info"),m=m.append("form").selectAll("span").data(d).enter().append("span"),m.append("input").attr("type","radio").attr("name","menu").attr("value",function(a){return a}).attr("checked",function(a,b){if(0===b)return"checked"}).on("change",function(){f=this.value,console.log("nodeInfokey: "+f),v()}),m.append("label").text(function(a){return a}),m.append("br")}}function C(){var a,b,c,g=d3.transition().duration(1e3);h=d3.select(".nodeScaling").node().checked,j.forEach(function(i,k){i.forEach(function(i,m){a=i.sankey,c=i.graph,h?a.maxValue(j.maxValue):a.maxValue(-1),a.layout(),b="g.sankeySeq.s"+k+"-"+m,d3.select(b).selectAll(".link").data(c.links,function(a){return a.id}).transition(g).attr("d",a.link()).style("stroke-width",function(a){return Math.max(1,a.dy)+"px"}),d3.select(b).selectAll(".node").data(c.nodes).transition(g).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),d3.select(b).selectAll("rect.sankeyNode").transition(g).attr("height",function(a){return a.dy});var n=d3.select("rect.coverSankeySeq").attr("height");d3.select(b).selectAll("text.nodeLabel").transition(g).attr("y",function(a){var b=G(d3.select(this.parentNode).attr("transform"))[1],c=parseInt(d3.select(this).style("font-size"));return b+c>n?a.dy-c/2-1:a.dy/2}),d3.select(b).selectAll("rect.sankeyNodeInfo").filter(function(b){return d.forEach(function(c){c!==e?b.nodeInfos[c+"_dy"]=a.getNodeHeight(+b.nodeInfos[c]):f===e&&d3.selectAll("rect.sankeyNodeInfo").attr("y",function(a){return a.dy})}),void 0!==b.nodeInfos}).attr("height",function(a){return d3.select(this).attr("height")}).transition(g).attr("y",function(a){return f===e?a.dy:(l&&(console.log("value: "+ +a.nodeInfos[f]),console.log("newHeight: "+a.nodeInfos[f+"_dy"])),a.dy-a.nodeInfos[f+"_dy"])}).attr("height",function(a){return f===e?0:a.nodeInfos[f+"_dy"]})})})}function D(){d3.selectAll("text.nodeLabel").style("display",function(){return d3.select(".labelOnOff").node().checked?"block":"none"})}function v(){var a=d3.transition().duration(1e3);d3.select("div.NodeInfoMenu").transition(a).style("border-color",function(){return f===e?"rgba(0,0,0,0.1)":"orange"}).style("background-color",function(){return f===e?"rgba(0,0,0,0.1)":"rgba(255,165,0,0.1)"}),d3.selectAll("rect.sankeyNodeInfo").style("display","inline").transition(a).attr("y",function(a){return f===e?a.dy:(l&&(console.log("value: "+ +a.nodeInfos[f]),console.log("newHeight: "+a.nodeInfos[f+"_dy"])),a.dy-a.nodeInfos[f+"_dy"])}).attr("height",function(a){return f===e?0:a.nodeInfos[f+"_dy"]}).transition().delay(10).duration(10).style("display",function(a){return f===e?"none":"inline"})}function E(a,b){j=J(b);var c,i,u,v,C,D,E,I,K,M,N,L=!0;a.each(function(){B(a),N=d3.select(this).append("div").attr("class","sankeyChart").append("svg").attr("width",o[0]).attr("height",o[1]).append("g").attr("transform","translate("+p.left+","+p.top+")"),K=x(N),1===j.cols&&1===j.rows&&(d3.selectAll(".axis").style("opacity",1),d3.selectAll(".sankeyNode,.sankeyNodeInfo").style("stroke-width","1px")),i=K.width,u=K.height,l&&(console.log("allGraphs:"),console.log(j)),j.forEach(function(a,b){a.forEach(function(a,o){I=a.graph,l&&(console.log("col: "+a.dimCol),console.log("row: "+a.dimRow)),c=d3.sankeySeq().size([i,u]).sequence(q).categories(r).nodeWidth(m).nodePadding(n).nodes(I.nodes).links(I.links).debugOn(l),h&&c.maxValue(j.maxValue),c.layout(),a.sankey=c,M=y(N,K,j,b,o),C=N.append("g").datum(M.sankeyFrame).attr("class","sankeyFrame f"+b+"-"+o).attr("transform",M.sankeyFrame.multiples).on("click",function(){1===j.cols&&1===j.rows||(L=L?z(this):A(this))}),v=C.append("g").datum(M.sankeySeq).attr("class","sankeySeq s"+b+"-"+o).attr("transform",M.sankeySeq.multiples);var p=C.append("g").datum(M.pTop).attr("class","sankeyPad multiples pTop").attr("transform",M.pTop.multiples);p.append("text").attr("class","multiples col c"+b).text(function(){return 1===j.cols&&j.rows>1?a.dimRow:a.dimCol}),p.append("text").attr("class","single col c"+b).style("opacity",0).text(function(){return 1===j.cols&&j.rows>1?a.dimRow:a.dimRow+"    "+a.dimCol}),C.append("g").datum(M.pLeft).attr("class","sankeyPad multiples pLeft").attr("transform",M.pLeft.multiples).append("text").attr("class","multiples row r"+o).attr("transform","rotate(-90)").text(function(){var b="";return j.cols>1&&j.rows>1&&(b=a.dimRow),b}),v.append("rect").attr("class","coverSankeySeq").attr("height",u).attr("width",i+2).style("stroke","black").style("stroke-width",1).style("fill-opacity",0),k=d3.select("body").append("div").attr("class","tooltip"),D=v.append("g").selectAll(".link").data(I.links).enter().append("path").attr("class",function(a){return"link lsx"+a.source.nameX.replace(/ /g,"_")+" lsy"+a.source.nameY.replace(/ /g,"_")+" ltx"+a.target.nameX.replace(/ /g,"_")+" lty"+a.target.nameY.replace(/ /g,"_")}).attr("d",c.link()).style("stroke-width",function(a){return Math.max(1,a.dy)+"px"}).sort(function(a,b){return b.dy-a.dy}).on("mouseover",function(a){var b=s+": "+a.source.nameX+" -> "+a.target.nameX;b+="<br>"+t+": "+a.source.nameY+" -> "+a.target.nameY,b+="<br>"+g+": "+H(a.value),k.html(b),k.style("visibility","visible")}).on("mousemove",function(){var a=19,b=19,c=k.style("width").indexOf("px");-1!=c&&(a+=+k.style("width").substr(0,c));var c=k.style("height").indexOf("px");-1!=c&&(b+=+k.style("height").substr(0,c));var d=d3.event.pageY-100<0?d3.event.pageY+23:d3.event.pageY-b,e=d3.event.pageX+250<window.innerWidth?d3.event.pageX+5:d3.event.pageX-a;return k.style("top",d+"px").style("left",e+"px")}).on("mouseout",function(){return k.style("visibility","hidden")}),E=v.append("g").selectAll(".node").data(I.nodes).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),E.append("rect").attr("class",function(a){var b="sankeyNode nx"+a.nameX.replace(/ /g,"_")+" ny"+a.nameY.replace(/ /g,"_");return w.categories().forEach(function(c,d){c===a.nameY&&(b+=" color"+d%5)}),b}).attr("height",function(a){return a.dy}).attr("width",c.nodeWidth()).on("mouseover",function(a){var b=s+": "+a.nameX;b+="<br>"+t+": "+a.nameY,b+="<br>"+g+": "+H(a.value),k.html(b),k.style("visibility","visible")}).on("mousemove",F).on("mouseout",function(){return k.style("visibility","hidden")});var x=d3.select("rect.coverSankeySeq").attr("height");E.append("text").attr("class","nodeLabel").style("display",function(){return d3.select(".labelOnOff").node().checked?"block":"none"}).attr("x",3+c.nodeWidth()).attr("y",function(a){return a.dy/2}).attr("dy",".35em").attr("text-anchor","start").attr("transform",null).style("opacity",0).text(function(a){return a.nameY}).each(function(a){var b=G(d3.select(this.parentNode).attr("transform"))[1],c=parseInt(d3.select(this).style("font-size"));b+c>x&&d3.select(this).attr("y",function(a){return a.dy-c/2-1})}).filter(function(a){return a.x>.9*i}).attr("x",-3).attr("text-anchor","end"),E.filter(function(a){return void 0!==a.nodeInfos}).append("rect").attr("class","sankeyNodeInfo").attr("y",function(a){return a.dy}).attr("height",function(a){return d.forEach(function(b){b!==e&&(a.nodeInfos[b+"_dy"]=c.getNodeHeight(+a.nodeInfos[b]))}),0}).attr("width",c.nodeWidth()).style("fill","orange").style("display",function(a){return f===e?"none":"inline"}).on("mouseover",function(a){var b=s+": "+a.nameX;b+="<br>"+t+": "+a.nameY,b+="<br>"+g+" ("+f+"): "+a.nodeInfos[f],k.html(b),k.style("visibility","visible")}).on("mousemove",F).on("mouseout",function(){return k.style("visibility","hidden")}),"single"===a.transform&&z(C.node(),d3.transition().duration(0))})})})}function F(){var a=19,b=19,c=k.style("width").indexOf("px");-1!=c&&(a+=+k.style("width").substr(0,c));var c=k.style("height").indexOf("px");-1!=c&&(b+=+k.style("height").substr(0,c));var d=d3.event.pageY-100<0?d3.event.pageY+23:d3.event.pageY-b,e=d3.event.pageX+250<window.innerWidth?d3.event.pageX+5:d3.event.pageX-a;return k.style("top",d+"px").style("left",e+"px")}function G(a){var b=document.createElementNS("http://www.w3.org/2000/svg","g");b.setAttributeNS(null,"transform",a);var c=b.transform.baseVal.consolidate().matrix;return[c.e,c.f]}function H(a){var b=d3.format(",.0f");if("."===u){if(+a%1!=0)return a.split(".").join(",");return b(a).split(",").join(".")}return+a%1!=0?a:b(a)}function I(d,e){if("<pre>"!==d)d3.csv(d,function(d,f){var g=a.slice(0,a.lastIndexOf("."))+"_nodes"+a.slice(a.lastIndexOf("."));d3.csv(g,function(a,d){l&&(console.log("start"),console.log(a),console.log(d),console.log("end")),c=d,b=f,l&&(console.log("file: "),console.log(b),console.log("nodeFileName: "),console.log(g),console.log("nodeFile: "),console.log(c)),E(e,f)})});else{if(b=d3.csvParse(d3.select("pre#data").text()),c=d3.csvParse(d3.select("pre#dataNodes").text()),0===c.length){var f;c=f}l&&(console.log("file: "),console.log(b),console.log("nodeFile: "),console.log(c)),E(e,b)}}function J(a){var h,i,n,p,s,t,u,v,b={},f=[],j=a.columns,k=[],m=d3.map(),w=0;return console.log(a.columns),void 0===g&&(g=a.columns[0]),5===a.columns.length?(k=d3.nest().key(function(a){return""}).key(function(a){return""}).entries(a),void 0!==c&&(c.forEach(function(a){n=a.sourceX+","+a.sourceY,m.set(n,a),l&&console.log(a)}),d=c.columns,d.splice(0,2,e))):6===a.columns.length?(k=d3.nest().key(function(a){return""}).key(function(a){return a[j[5]]}).sortKeys(d3.ascending).entries(a),void 0!==c&&(c.forEach(function(b){n=b[a.columns[5]]+","+b.sourceX+","+b.sourceY,m.set(n,b),l&&console.log(b)}),d=c.columns,d.splice(0,3,e))):7===a.columns.length&&(k=d3.nest().key(function(a){return a[j[6]]}).sortKeys(d3.ascending).key(function(a){return a[j[5]]}).sortKeys(d3.ascending).entries(a),l&&console.log("----------- nodeInfos ------------"),void 0!==c&&(c.forEach(function(b){n=b[a.columns[6]]+","+b[a.columns[5]]+","+b.sourceX+","+b.sourceY,m.set(n,b),l&&console.log(b)}),d=c.columns,d.splice(0,4,e))),f.rows=d3.nest().key(function(a){return a[j[5]]}).entries(a).length,f.cols=d3.nest().key(function(a){return a[j[6]]}).entries(a).length,l&&(console.log("----------- datagroups ------------"),console.log(k),console.log("----------nodeMap----------"),console.log(m)),k.forEach(function(a,c){f[c]=[],a.values.forEach(function(d,e){p=d.values,b={nodes:[],links:[]},l&&console.log("graph0: "),p.forEach(function(a,c){l&&(console.log("i: "+c),console.log(a)),h=a[j[1]]+"_"+a[j[2]],i=a[j[3]]+"_"+a[j[4]],b.nodes.push({name:h}),b.nodes.push({name:i}),b.links.push({source:h,target:i,id:h+"->"+i,value:+a[j[0]]})}),l&&(console.log("graph1: "),console.log(JSON.stringify(b))),b.nodes=d3.nest().key(function(a){return a.name}).map(b.nodes).keys(),l&&(console.log("graph2: "),console.log(JSON.stringify(b))),b.links.forEach(function(a,c){b.links[c].source=b.nodes.indexOf(b.links[c].source),b.links[c].target=b.nodes.indexOf(b.links[c].target)}),b.nodes.forEach(function(c,e){var f=c.split("_")[0],g=c.split("_")[1];b.nodes[e]={name:c,nameX:f,nameY:g};var h,i=""===a.key?"":a.key+",",j=""===d.key?"":d.key+",";void 0!==(h=m.get(i+j+f+","+g))&&(Object.keys(h).forEach(function(a){h[a+"_dy"]=0}),b.nodes[e].nodeInfos=h)}),l&&(console.log("graph 3"),console.log(JSON.stringify(b)),console.log(b)),q||(q=d3.set(b.nodes.map(function(a){return a.nameX})).values().sort(d3.ascending)),r||(r=d3.set(b.nodes.map(function(a){return a.nameY})).values().sort(d3.ascending)),l&&(console.log("categoriesSorted: "),console.log(r)),s={},s.graph=b,s.dimRow=d.key,s.dimCol=a.key,t=d3.nest().key(function(a){return a.source}).rollup(function(a){return d3.sum(a,function(a){return+a.value})}).entries(b.links),u=d3.nest().key(function(a){return a.target}).rollup(function(a){return d3.sum(a,function(a){return+a.value})}).entries(b.links),t=t.concat(u),v=d3.max(t,function(a){return a.value}),w=v>w?v:w,1===f.cols&&1===f.rows?s.transform="single":s.transform="multiples",f[c].push(s)})}),l&&console.log("maxValue: "+w),f.maxValue=w,f}var b,c,d,g,j,k,q,r,v,e="(none)",f=e,h=!0,i=!0,l=!1,m=15,n=8,o=[700,500],p={left:5,top:5,right:5,bottom:5},s="sequence",t="category",u=",";return w.debugOn=function(a){return arguments.length?(l=a,w):l},w.size=function(a){return arguments.length?(o=a,w):o},w.margin=function(a){return arguments.length?(p.left=a,p.top=a,p.right=a,p.bottom=a,w):p},w.nodeWidth=function(a){return arguments.length?(m=+a,w):m},w.nodePadding=function(a){return arguments.length?(n=+a,w):n},w.sequence=function(a){return arguments.length?(q=a,w):q},w.categories=function(a){return arguments.length?(r=a,w):r},w.sequenceName=function(a){return arguments.length?(s=a,w):s},w.categoryName=function(a){return arguments.length?(t=a,w):t},w.valueName=function(a){return arguments.length?(g=a,w):g},w.thousandsSeparator=function(a){return arguments.length?(u=a,w):u},w.scaleGlobal=function(a){return arguments.length?(h=a,w):h},w.showNodeLabels=function(a){return arguments.length?(i=a,w):i},w};