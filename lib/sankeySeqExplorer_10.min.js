var reUsableChart=function(a){"use strict";function u(b){b.each(function(c){console.log(c),console.log("_myData "+a),"undefined"!=typeof c?C(b,c):"undefined"!=typeof a?D(a,b):D("<pre>",b)})}function v(a,b,c){b=n[0]-o.left-o.right,c=n[1]-o.bottom-o.top;var d={left:0,bottom:0,right:0,top:20},e={left:20,bottom:0,right:0,top:20},f=a.append("g").attr("class","dummy").style("opacity",0).call(d3.axisLeft(d3.scalePoint().domain(q))),g=f.call(d3.axisBottom(d3.scalePoint().domain(p)));d.left=f.node().getBBox().width,d.bottom=g.node().getBBox().height,b-=d.left,c=c-d.bottom-e.top,d3.selectAll("g.dummy").remove();var h=d3.scalePoint().domain(q).range([c,c/q.length]),i=d3.axisLeft(h),j=a.append("g").attr("class","axis left").style("opacity",0).call(i);d.left=j.node().getBBox().width,j.attr("transform","translate("+(d.left-1.5)+", "+d.top+")");var k=d3.scalePoint().domain(p).range([0,b-l]),m=d3.axisBottom(k),j=a.append("g").attr("class","axis bottom").style("opacity",0).call(m);d.bottom=j.node().getBBox().height,j.attr("transform","translate("+d.left+", "+(c+e.top)+")");var r={};return r.paddingSingle=d,r.paddingMultiples=e,r.width=b,r.height=c,r}function w(a,b,c,d,e){var f=b.width,g=b.height,h=b.paddingMultiples,i=d*f/c.cols,j=e*g/c.rows,k=(1/c.cols*f-h.left)/f,l=(1/c.rows*g-h.top)/g;k>=l?k=l:l=k;var m={};return m.sankeyFrame={},m.sankeyFrame.single="translate("+(i+f/2*k)+", "+(j+g/2*l)+") scale(0.05)",m.sankeyFrame.multiples="translate("+i+", "+j+") ",m.sankeySeq={},m.sankeySeq.single="translate("+b.paddingSingle.left+", 20) ",m.sankeySeq.multiples="translate("+h.left+", "+h.top+") scale("+k+", "+l+")",m.pTop={},m.pTop.single="translate("+(h.left+f/2)+", "+(h.top-3)+")",m.pTop.multiples="translate("+(h.left+f/2*k)+", "+(h.top-3)+")",m.pLeft={},m.pLeft.single="translate("+(h.left-3)+", "+(h.top+g/2)+")",m.pLeft.multiples="translate("+(h.left-3)+", "+(h.top+g/2*l)+")",m}function x(a,b){var c="undefined"!=typeof b?b:d3.transition().duration(1e3);return d3.selectAll("g.sankeyFrame").each(function(b){this===a?(console.log("clicked"),d3.select(this).transition(c).attr("transform","translate(0, 0)"),d3.select(this).selectAll("g.pTop").transition(c).attr("transform",function(a){return a.single}),d3.select(this).selectAll("text.col.multiples").transition(c).style("opacity",0),d3.select(this).selectAll("text.col.single").transition(c).style("opacity",1),d3.select(this).selectAll("text.nodeLabel").transition(c).style("opacity",1),d3.select(this).selectAll("g.pLeft").transition(c).style("opacity",0),d3.select(this).selectAll("g.sankeySeq").transition(c).attr("transform",function(a){return a.single}),d3.selectAll(".axis").transition().delay(800).style("opacity",1),d3.selectAll(".coverSankeySeq").transition(c).style("opacity",0)):(console.log("not clicked"),d3.select(this).transition(c).attr("transform",function(a){return a.single}).style("opacity",0))}),!1}function y(a){var b=d3.transition().duration(1e3);return d3.selectAll("g.sankeyFrame").each(function(c){this===a?(console.log("clicked"),d3.select(this).transition(b).attr("transform",function(a){return a.multiples}),d3.select(this).selectAll("g.pTop").transition(b).attr("transform",function(a){return a.multiples}),d3.select(this).selectAll("text.col.multiples").transition(b).style("opacity",1),d3.select(this).selectAll("text.col.single").transition(b).style("opacity",0),d3.select(this).selectAll("text.nodeLabel").transition(b).style("opacity",0),d3.select(this).selectAll("g.pLeft").transition(b).style("opacity",1),d3.select(this).selectAll("g.sankeySeq").transition(b).attr("transform",function(a){return a.multiples}),d3.selectAll(".axis").transition(b).style("opacity",0),d3.selectAll(".coverSankeySeq").transition(b).style("opacity",1)):d3.select(this).transition(b).attr("transform",function(a){return a.multiples}).style("opacity",1)}),!0}function z(a){var b=a.append("div").attr("class","sankeyMenu"),e=b.append("div").attr("class","OptionsMenu");if(e.append("div").attr("class","titleMenu").append("label").text("options"),1!==j.cols||1!==j.rows){e.append("span").attr("class","span1").append("input").attr("class","nodeScaling").attr("type","checkbox").attr("value","global").attr("checked","checked").on("change",A);e.select("span.span1").append("label").text("global scale"),e.append("br")}e.append("span").attr("class","span2").append("input").attr("class","labelOnOff").attr("type","checkbox").attr("value",i).attr("checked","checked").on("change",B);if(b.select("span.span2").append("label").text("node labels"),"undefined"!=typeof c){k&&(console.log("nodeInfoKeys: "),console.log(d));var l=d3.select("div.sankeyMenu").append("div").attr("class","NodeInfoMenu");l.append("div").attr("class","titleMenu").append("label").text("node info"),l=l.append("form").selectAll("span").data(d).enter().append("span"),l.append("input").attr("type","radio").attr("name","menu").attr("value",function(a){return a}).attr("checked",function(a,b){if(0===b)return"checked"}).on("change",function(){f=this.value,console.log("nodeInfokey: "+f),t()}),l.append("label").text(function(a){return a}),l.append("br")}}function A(){var a,b,c,g=d3.transition().duration(1e3),i=d3.select(".nodeScaling").attr("value");"global"==i?(d3.select(".nodeScaling").attr("value","local"),h=!1):(d3.select(".nodeScaling").attr("value","global"),h=!0),j.forEach(function(i,l){i.forEach(function(i,m){a=i.sankey,c=i.graph,h?a.maxValue(j.maxValue):a.maxValue(-1),a.layout(),b="g.sankeySeq.s"+l+"-"+m,d3.select(b).selectAll(".link").data(c.links,function(a){return a.id}).transition(g).attr("d",a.link()).style("stroke-width",function(a){return Math.max(1,a.dy)+"px"}),d3.select(b).selectAll(".node").data(c.nodes).transition(g).attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),d3.select(b).selectAll("rect.sankeyNode").transition(g).attr("height",function(a){return a.dy}),d3.select(b).selectAll("text.nodeLabel").transition(g).attr("y",function(a){return a.dy/2}),d3.select(b).selectAll("rect.sankeyNodeInfo").filter(function(b){return d.forEach(function(c){c!==e?b.nodeInfos[c+"_dy"]=a.getNodeHeight(+b.nodeInfos[c]):f===e&&d3.selectAll("rect.sankeyNodeInfo").attr("y",function(a){return a.dy})}),"undefined"!=typeof b.nodeInfos}).attr("height",function(a){return d3.select(this).attr("height")}).transition(g).attr("y",function(a){return f===e?a.dy:(k&&(console.log("value: "+ +a.nodeInfos[f]),console.log("newHeight: "+a.nodeInfos[f+"_dy"])),a.dy-a.nodeInfos[f+"_dy"])}).attr("height",function(a){return f===e?0:a.nodeInfos[f+"_dy"]})})})}function B(){var a=d3.select(".labelOnOff").attr("value");"on"===a?(d3.select(".labelOnOff").attr("value","off"),d3.selectAll("text.nodeLabel").style("display","none")):(d3.select(".labelOnOff").attr("value","on"),d3.selectAll("text.nodeLabel").style("display","block"))}function t(){var a=d3.transition().duration(1e3);d3.select("div.NodeInfoMenu").transition(a).style("border-color",function(){return f===e?"rgba(0,0,0,0.1)":"orange"}).style("background-color",function(){return f===e?"rgba(0,0,0,0.1)":"rgba(255,165,0,0.1)"}),d3.selectAll("rect.sankeyNodeInfo").transition(a).attr("y",function(a){return f===e?a.dy:(k&&(console.log("value: "+ +a.nodeInfos[f]),console.log("newHeight: "+a.nodeInfos[f+"_dy"])),a.dy-a.nodeInfos[f+"_dy"])}).attr("height",function(a){return f===e?0:a.nodeInfos[f+"_dy"]})}function C(a,b){j=E(b);var c,i,t,u,A,B,C,D,F,H,I,G=!0;a.each(function(){z(a),I=d3.select(this).append("div").attr("class","sankeyChart").append("svg").attr("width",n[0]).attr("height",n[1]).append("g").attr("transform","translate("+o.left+","+o.top+")"),F=v(I,i,t),1===j.cols&&1===j.rows&&d3.selectAll(".axis").style("opacity",1),i=F.width,t=F.height,k&&(console.log("allGraphs:"),console.log(j)),j.forEach(function(a,b){a.forEach(function(a,n){D=a.graph,k&&(console.log("col: "+a.dimCol),console.log("row: "+a.dimRow)),c=d3.sankeySeq().size([i,t]).sequence(p).categories(q).nodeWidth(l).nodePadding(m).nodes(D.nodes).links(D.links).debugOn(k),h&&c.maxValue(j.maxValue),c.layout(),a.sankey=c,H=w(I,F,j,b,n),A=I.append("g").datum(H.sankeyFrame).attr("class","sankeyFrame f"+b+"-"+n).attr("transform",H.sankeyFrame.multiples).on("click",function(){1===j.cols&&1===j.rows||(G=G?x(this):y(this))}),u=A.append("g").datum(H.sankeySeq).attr("class","sankeySeq s"+b+"-"+n).attr("transform",H.sankeySeq.multiples);var o=A.append("g").datum(H.pTop).attr("class","sankeyPad multiples pTop").attr("transform",H.pTop.multiples);o.append("text").attr("class","multiples col c"+b).text(function(){var b="";return b=1===j.cols&&j.rows>1?a.dimRow:a.dimCol}),o.append("text").attr("class","single col c"+b).style("opacity",0).text(function(){var b="";return b=1===j.cols&&j.rows>1?a.dimRow:a.dimRow+"    "+a.dimCol}),A.append("g").datum(H.pLeft).attr("class","sankeyPad multiples pLeft").attr("transform",H.pLeft.multiples).append("text").attr("class","multiples row r"+n).attr("transform","rotate(-90)").text(function(){var b="";return j.cols>1&&j.rows>1&&(b=a.dimRow),b}),u.append("rect").attr("class","coverSankeySeq").attr("height",t).attr("width",i).style("stroke","black").style("stroke-width",1).style("fill-opacity",0);var v=d3.select("body").append("div").attr("class","tooltip");B=u.append("g").selectAll(".link").data(D.links).enter().append("path").attr("class",function(a){return"link l"+a.id.replace(">","").replace(" ","_")}).attr("d",c.link()).style("stroke-width",function(a){return Math.max(1,a.dy)+"px"}).sort(function(a,b){return b.dy-a.dy}).on("mouseover",function(a){var b=r+": "+a.source.nameX+" -> "+a.target.nameX;b+="<br>"+s+": "+a.source.nameY+" -> "+a.target.nameY,b+="<br>"+g+": "+a.value,v.html(b),v.style("visibility","visible")}).on("mousemove",function(){var a=19,b=19,c=v.style("width").indexOf("px");c!=-1&&(a+=+v.style("width").substr(0,c));var c=v.style("height").indexOf("px");c!=-1&&(b+=+v.style("height").substr(0,c));var d=d3.event.pageY-100<0?d3.event.pageY+23:d3.event.pageY-b,e=d3.event.pageX+250<window.innerWidth?d3.event.pageX+5:d3.event.pageX-a;return v.style("top",d+"px").style("left",e+"px")}).on("mouseout",function(){return v.style("visibility","hidden")}),C=u.append("g").selectAll(".node").data(D.nodes).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),C.append("rect").attr("class",function(a){return"sankeyNode n"+a.nameX.replace(" ","_")+"_"+a.nameY.replace(" ","_")}).attr("height",function(a){return a.dy}).attr("width",c.nodeWidth()).on("mouseover",function(a){var b=r+": "+a.nameX;b+="<br>"+s+": "+a.nameY,b+="<br>"+g+": "+a.value,v.html(b),v.style("visibility","visible")}).on("mousemove",function(){var a=19,b=19,c=v.style("width").indexOf("px");c!=-1&&(a+=+v.style("width").substr(0,c));var c=v.style("height").indexOf("px");c!=-1&&(b+=+v.style("height").substr(0,c));var d=d3.event.pageY-100<0?d3.event.pageY+23:d3.event.pageY-b,e=d3.event.pageX+250<window.innerWidth?d3.event.pageX+5:d3.event.pageX-a;return v.style("top",d+"px").style("left",e+"px")}).on("mouseout",function(){return v.style("visibility","hidden")}),C.append("text").attr("class","nodeLabel").attr("x",3+c.nodeWidth()).attr("y",function(a){return a.dy/2}).attr("dy",".35em").attr("text-anchor","start").attr("transform",null).style("opacity",0).text(function(a){return a.nameY}).filter(function(a){return a.x>.9*i}).attr("x",-3).attr("text-anchor","end"),C.filter(function(a){return"undefined"!=typeof a.nodeInfos}).append("rect").attr("class","sankeyNodeInfo").attr("y",function(a){return a.dy}).attr("height",function(a){return d.forEach(function(b){b!==e&&(a.nodeInfos[b+"_dy"]=c.getNodeHeight(+a.nodeInfos[b]))}),0}).attr("width",c.nodeWidth()).style("fill","orange").on("mouseover",function(a){var b=r+": "+a.nameX;b+="<br>"+s+": "+a.nameY,b+="<br>"+g+"("+f+"): "+a.nodeInfos[f],v.html(b),v.style("visibility","visible")}).on("mousemove",function(){return v.style("top",d3.event.pageY-30+"px").style("left",d3.event.pageX+10+"px")}).on("mouseout",function(){return v.style("visibility","hidden")}),"single"===a.transform&&x(A.node(),d3.transition().duration(0))})})})}function D(d,e){if("<pre>"!==d)d3.csv(d,function(d,f){var g=a.slice(0,a.lastIndexOf("."))+"_nodes"+a.slice(a.lastIndexOf("."));d3.csv(g,function(a,d){k&&(console.log("start"),console.log(a),console.log(d),console.log("end")),c=d,b=f,k&&(console.log("file: "),console.log(b),console.log("nodeFileName: "),console.log(g),console.log("nodeFile: "),console.log(c)),C(e,f)})});else{if(b=d3.csvParse(d3.select("pre#data").text()),c=d3.csvParse(d3.select("pre#dataNodes").text()),0===c.length){var f;c=f}k&&(console.log("file: "),console.log(b),console.log("nodeFile: "),console.log(c)),C(e,b)}}function E(a){var h,i,n,r,s,t,u,v,b={},f=[],j=a.columns,l=[],m=d3.map(),w=0;return console.log(a.columns),"undefined"==typeof g&&(g=a.columns[0]),5===a.columns.length?(l=d3.nest().key(function(a){return""}).key(function(a){return""}).entries(a),"undefined"!=typeof c&&(c.forEach(function(a){n=a.sourceX+","+a.sourceY,m.set(n,a),k&&console.log(a)}),d=c.columns,d.splice(0,2,e))):6===a.columns.length?(l=d3.nest().key(function(a){return""}).key(function(a){return a[j[5]]}).sortKeys(d3.ascending).entries(a),"undefined"!=typeof c&&(c.forEach(function(b){n=b[a.columns[5]]+","+b.sourceX+","+b.sourceY,m.set(n,b),k&&console.log(b)}),d=c.columns,d.splice(0,3,e))):7===a.columns.length&&(l=d3.nest().key(function(a){return a[j[6]]}).sortKeys(d3.ascending).key(function(a){return a[j[5]]}).sortKeys(d3.ascending).entries(a),k&&console.log("----------- nodeInfos ------------"),"undefined"!=typeof c&&(c.forEach(function(b){n=b[a.columns[6]]+","+b[a.columns[5]]+","+b.sourceX+","+b.sourceY,m.set(n,b),k&&console.log(b)}),d=c.columns,d.splice(0,4,e))),f.rows=d3.nest().key(function(a){return a[j[5]]}).entries(a).length,f.cols=d3.nest().key(function(a){return a[j[6]]}).entries(a).length,k&&(console.log("----------- datagroups ------------"),console.log(l),console.log("----------nodeMap----------"),console.log(m)),l.forEach(function(a,c){f[c]=[],a.values.forEach(function(d,e){r=d.values,b={nodes:[],links:[]},k&&console.log("graph0: "),r.forEach(function(a,c){k&&(console.log("i: "+c),console.log(a)),h=a[j[1]]+"_"+a[j[2]],i=a[j[3]]+"_"+a[j[4]],b.nodes.push({name:h}),b.nodes.push({name:i}),b.links.push({source:h,target:i,id:h+"->"+i,value:+a[j[0]]})}),k&&(console.log("graph1: "),console.log(JSON.stringify(b))),b.nodes=d3.nest().key(function(a){return a.name}).map(b.nodes).keys(),k&&(console.log("graph2: "),console.log(JSON.stringify(b))),b.links.forEach(function(a,c){b.links[c].source=b.nodes.indexOf(b.links[c].source),b.links[c].target=b.nodes.indexOf(b.links[c].target)}),b.nodes.forEach(function(c,e){var g=c.split("_")[0],h=c.split("_")[1];b.nodes[e]={name:c,nameX:g,nameY:h};var i;i=1!==f.cols&&1!==f.rows?m.get(a.key+","+d.key+","+g+","+h):1===f.cols&&1!==f.rows?m.get(d.key+","+g+","+h):m.get(g+","+h),"undefined"!=typeof i&&(Object.keys(i).forEach(function(a){i[a+"_dy"]=0}),b.nodes[e].nodeInfos=i)}),k&&(console.log("graph 3"),console.log(JSON.stringify(b)),console.log(b)),p||(p=d3.set(b.nodes.map(function(a){return a.nameX})).values().sort(d3.ascending)),q||(q=d3.set(b.nodes.map(function(a){return a.nameY})).values().sort(d3.ascending)),k&&(console.log("categoriesSorted: "),console.log(q)),s={},s.graph=b,s.dimRow=d.key,s.dimCol=a.key,t=d3.nest().key(function(a){return a.source}).rollup(function(a){return d3.sum(a,function(a){return+a.value})}).entries(b.links),u=d3.nest().key(function(a){return a.target}).rollup(function(a){return d3.sum(a,function(a){return+a.value})}).entries(b.links),t=t.concat(u),v=d3.max(t,function(a){return a.value}),w=v>w?v:w,1===f.cols&&1===f.rows?s.transform="single":s.transform="multiples",f[c].push(s)})}),k&&console.log("maxValue: "+w),f.maxValue=w,f}var b,c,d,g,j,p,q,t,e="(none)",f=e,h=!0,i="on",k=!1,l=15,m=8,n=[700,500],o={left:5,top:0,right:0,bottom:0},r="sequence",s="category";return u.debugOn=function(a){return arguments.length?(k=a,u):k},u.size=function(a){return arguments.length?(n=a,u):n},u.margin=function(a){return arguments.length?(o.left=a,o.top=a,o.right=a,o.bottom=a,u):o},u.nodeWidth=function(a){return arguments.length?(l=+a,u):l},u.nodePadding=function(a){return arguments.length?(m=+a,u):m},u.sequence=function(a){return arguments.length?(p=a,u):p},u.categories=function(a){return arguments.length?(q=a,u):q},u.sequenceName=function(a){return arguments.length?(r=a,u):r},u.categoryName=function(a){return arguments.length?(s=a,u):s},u.valueName=function(a){return arguments.length?(g=a,u):g},u};